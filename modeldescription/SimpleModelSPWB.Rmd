---
title: "Soil-plant water balance model"
author: 
  - name: "Miquel De Caceres"
    affiliation: 
    - &CTFC "CTFC. Ctra. St. Llorenç de Morunys km 2, 25280, Solsona, Catalonia, Spain"
    - &CREAF "CREAF, Cerdanyola del Vallès, 08193, Spain"
  - name: "Victor Granda"
    affiliation: *CREAF
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: yes
  html_document:
    df_print: paged
    toc: yes
fontsize: 11pt
documentclass: article
citation_package: natbib
bibliography: book.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(medfate)
```

# Model overview

## Design principles

The water balance model calculates temporal variations in soil moisture on a daily step basis for the input forest stand and for the period corresponding to input weather data. 

The model considers only the vertical spatial dimension of the stand and not the horizontal distribution of
plants within it. In other words, the model is not spatially explicit (i.e., plants do not interact for space explicitly). Still, the stand is divided into groups of plants, here referred to as *plant cohorts* of different species, height and leaf area index ($LAI$). Height and $LAI$ values determine competition for light. $LAI$ values also drive competition for water, along with root distribution. The soil water balance follows the design principles of SIERRA [@Mouillot2001;@Ruffault2014;@Ruffault2013] and BILJOU [@Granier1999;-@Granier2007], although some features are taken from other models [@Kergoat1998]. Potential evapotranspiration ($PET$) is given as input and the model determines maximum canopy transpiration ($Tr_{\max}$) using an empirical relationship between the $LAI$ of the stand and the ratio $Tr_{\max}/PET$ [@Granier1999]. Actual plant transpiration is estimated using a function that depends on current soil moisture levels, species-specific drought resistance, fine root distribution and the degree of shading of the target plant cohort.


## State variables
The model has the following state variables:

+ Cumulative growth degree days, $GDD$, are tracked by the model and determine leaf phenological status of winter deciduous species.
+ Daily soil moisture content dynamics on each layer $s$ are tracked using $W_s = \theta(\Psi_s)/ \theta_{fc,s}$, the **proportion of volumetric soil moisture in relation to field capacity**, where field capacity, $\theta_{fc,s}$, is assumed to correspond to $\Psi_{fc} = -0.033$ MPa. Note that $W_s$ values larger than one are possible if the soil is between field capacity and saturation (which can happen if deep drainage is not allowed).
+ If snow accumulation/melting is considered, the model tracks $S_{snow}$, the snow water equivalent (in mm) of the snow pack storage over the surface.
+ If irreversible cavitation is activated, the model tracks $P_{embolized,i}$, the maximum value of daily drought stress so far experienced.


## Water balance
Daily variations in soil water content (mm) can be summarized as:

\begin{equation}
\Delta{SWC} = Pr + Sm - In - Ru - Dd - Es -Tr
\end{equation}

where $Pr$ is precipitation as rainfall, $Sm$ is water from melting the snow pack (if considered), $In$ is the interception loss (i.e., water evaporated after being intercepted by the canopy), $Ru$ is surface runoff, $Dd$ is deep drainage (i.e. water percolated to layers beyond soil depth), $Es$ is evaporation from soil and $Tr$ is plant transpiration. If snow dynamics are considered, the water balance of the snow pack is defined as:

\begin{equation}
\Delta{S_{snow}} = Ps - Sm
\end{equation}

where $Ps$ is precipitation as snowfall and $Sm$ is snow melt.

## Process scheduling

Every day water balance is perfomed as follows. The model first updates leaf area values according to the phenology of species and calculates light extinction. After that, the model updates soil water content of soil layers in several steps:

+ If snow dynamics are included, increase snow pack from snow precipitation ($Ps$) and decreases it from snow melting ($Sm$);
+ Increase soil moisture due to rainfall ($Pr$), surface runon ($Ro$) and snow melting ($Sm$), after accounting for interception loss ($In$), surface runoff ($Ru$) and deep drainage ($Dd$);
+ Decrease water content due to bare soil evaporation ($Es$).
+ Determine transpiration, photosynthesis and drought stress for each plant cohort.
+ Decrease water content due to plant transpiration ($Tr$).

# Model inputs and outputs

## Soil description

Soil can be described using between 1 and 5 soil layers. For each soil layer $s$ the following physical parameters are needed for each soil layer (see function `defaultSoilParams()`):

+ $Z_{s}$ [`widths`]: Soil layer width ($d_s$, in mm).
+ $P_{clay,s}$ [`clay`]: Percent of clay.
+ $P_{sand,s}$ [`sand`]: Percent of sand.
+ $OM$ [`om`]: Percentage of organic mater per dry weight (can be missing).
+ $BD_{s}$ [`bd`]: Bulk density (g/cm3) of each soil layer.
+ $P_{rocks,s}$ [`rfc`]: Percentage of rock fragment content ($P_{rocks,s}$).

Soil texture (i.e. percent of sand, silt and clay), bulk density and rock fragment content can differ between soil layers. Specifying a deep rocky layer is important because Mediterranean plants may extend their roots into cracks existing in the parent rock [@Ruffault2013]. For those users lacking soil information, package **medfate** provides a function to get soil information from [SoilGrids.org](https://soilgrids.org/) (see function `soilgridsParams()`).

### Water retention curves

Water retention curve of a soil layer $s$ is the relationship between the water content, $\theta_s$ (in $m^3 \cdot m^{-3}$ of soil, excluding rock fragments), and the soil water potential, $\Psi_s$ (in MPa). This curve is characteristic for different types of soil, and is also called the soil moisture characteristic curve. Two water retention curve models are provided:

1. *Saxton model*: In this model, volumetric soil moisture $\theta(\Psi_s)$ corresponding to a given water potential $\Psi$ (in MPa) below $\Psi_{fc}$ is calculated using: 
\begin{equation}\theta(\Psi) = (\Psi/A)^{(1/B)}\end{equation}
where $A$ and $B$ depend on the texture and, if available, organic matter in the soil layer. If organic matter is available, $A$ and $B$ are calculated $P_{clay}$, $P_{sand}$ and $OM$ following @Saxton2006. Otherwise, they are calculated from $P_{clay}$ and $P_{sand}$ as indicated in @Saxton1986. Volumetric changes between field capacity and saturation are estimated using a linear function.
2. *Van Genuchten model*: The well known van Genuchten [@-Genuchten1980] model is:
\begin{equation}\theta(\Psi) = \theta_{res}+\frac{\theta_{sat}-\theta_{res}}{\left[1+ (\alpha \cdot \Psi)^n \right]^{1-1/n}}\end{equation}
where $\theta(\psi)$ is the water retention, $\theta_{sat}$ is the saturated water content, $\theta_{res}$ is the residual water content, $\alpha$ is related to the inverse of the air entry pressure (and here has to be expressed in MPa$^{-1}$), and $n$ is a measure of the pore-size distribution.


### Soil initialization
Soil initialization is needed to estimate soil hydrological parameters from its physical description. Initialization is done using function `soil()`, which adds the following information to the physical soil description: 

+ $P_{macro, s}$ [`macro`]: Percentage of macroporosity corresponding to each soil layers. Macroporosity values are calculated for each soil layer using the equations given in @Stolf2011.
+ $\gamma_{soil}$ [`Gsoil`]: The maximum daily evaporation from soil($mm \cdot day^{-1}$).
+ $\kappa_{soil}$ [`Ksoil`]: Extinction parameter to regulate the amount of water extracted from each soil layer during bare soil evaporation.
+ $n_{s}$, $\alpha_{s}$, $\theta_{sat,s}$,$\theta_{res,s}$ [`VG_n`, `VG_alpha`, `VG_theta_sat`, `VG_theta_res`]: Parameter of the Van Genuchten-Mualem equations.

Parameters of the van Genuchten-Mualem model are estimated from the physical description of the soil using two kinds of pedotransfer functions (see help for `soil()`): 

1. Using the USDA texture classification and the average texture class parameters given by @Carsel1988.
2. Directly from the soil texture, organic matter and bulk density, using the pedotransfer functions in @Toth2015.



### Water holding capacity and water table depth

Soil water holding capacity ($V_s$, in mm) in soil layer $s$ is defined as the volumetric water content at field capacity:
\begin{equation}
V_s = d_s\cdot ((100-P_{rocks,s})/100)\cdot\theta_{fc,s}
\end{equation}
where $d_s$ is the depth of the soil layer (in mm) and $P_{rocks,s}$ is the percentage of rock fragments. Thus, soil water holding capacity depends on the water retention curve used to determine $\theta_{fc} = \theta(-0.033)$. Soil water content at saturation is calculated anagolously, but replacing $\theta_{fc,s}$ by $\theta_{sat,s}$. Similarly water content at wilting point (-1.5 MPa) is calculated replacing $\theta_{fc,s}$ by $\theta_{wp,s}$ where $\theta_{wp} = \theta(-1.5)$. The amount of extractable water is difference between water content at field capacity and a the water content at a minimum water potential, which can be set at wilting point or lower values (by default at -5 MPa).

Water table depth ($WT$, in mm) equals soil depth when all soil layers are below field capacity. When some layers are between field capacity and saturation, water table depth is calculated as:
\begin{equation}
WT = \sum_{s}{d_s \cdot \min\left[1,(\theta_{sat,s} - \theta(\Psi_s))/(\theta_{sat,s}-\theta_{fc,s})\right]}
\end{equation}


## Vegetation description

Vegetation in the stand is described using a set of plant cohorts, in an object
of class `spwbInput`. Each plant cohort $i$ is primarly defined by its
species identity ($SP_i$; with R name [`SP`]).

### Aboveground parameters

The aboveground structure if each cohort is defined using the following attributes:

+ $H_i$ [`H`]: Total tree or shrub height (in cm).
+ $CR_i$ [`CR`]: Crown ratio (i.e. the ratio between crown length and
total height).
+ $LAI^{live}_i$ [`LAI_live`]: (Maximum) leaf area index (one-side
leaf area of plants in the cohort per surface area of the stand).
+ $LAI^{dead}_i$ [`LAI_dead`]: Dead leaf area index (one-side dead
leaf area of plants in the cohort per surface area of the stand).
+ $LAI^{\phi}_i$ [`LAI_expanded`]: Current expanded leaf area index (one-side expanded
leaf area of plants in the cohort per surface area of the stand).

All vegetation characteristics stay constant during water balance simulations, although the actual expanded leaf area and dead leaf area may vary is the species is winter deciduous.


### Belowground parameters

The root system of each plant cohorts is described using the proportion of fine
roots in each soil layer:

+ $v_{i,s}$ [`V`]: The proportion of fine roots in each soil layer $s$.

The rooting system of each cohort $i$ (i.e. the proportions $v_{i,s}$) can be defined assuming conic distribution of fine roots (see `root_conicDistribution()`). In this case, only rooting depth parameter is needed to determine fine root proportions. Alternatively, one can adopt the linear dose response model (Collins and Bras, 2007; Schenk and Jackson, 2002): 
\begin{equation}
Y_i(z)=\frac{1}{1+(z/Z_{50,i})^{c_i}}
\end{equation}
where $Y_i(z)$ is the cumulative fraction of fine root mass located between surface and depth $z$; $Z_{50,i}$ is the depth above which 50\% of the root mass is located; and $c_i$ is a shape parameter related to $Z_{50,i}$ and $Z_{95,i}$ as $c_i  = 2.94 / \ln(Z_{50,i} / Z_{95,i})$ (see `root_ldrDistribution()`). 

```{r, echo = FALSE, fig.width=7, fig.height=4, fig.cap = "Examples of root density profile according to a conic distribution (left) and the linear dose response model (right)."}
par(mar=c(4,4,1,1), mfrow=c(1,2))
P = root_conicDistribution(c(200,1500), rep(10,151))
matplot(x=t(P)*10, y=seq(0,1500, by=10), type="l", xlim=c(0,2), ylim=c(1500,0), ylab = "Depth (mm)", 
        xlab="Percentage of fine roots/mm")
legend("bottomright", legend=c("Z = 200", 
       "Z = 1500"), col=c("black","red"), lty=1:2, bty="n")
P = root_ldrDistribution(c(100,500), c(200,1500), rep(10,151))
matplot(x=t(P)*10, y=seq(0,1500, by=10), type="l", xlim=c(0,2), ylim=c(1500,0), ylab = "Depth (mm)", 
        xlab="Percentage of fine roots/mm")
legend("bottomright", legend=c("Z50 = 100, Z95 = 200", 
       "Z50 = 200, Z95 = 1500"), col=c("black","red"), lty=1:2, bty="n")
```


## Vegetation functional parameters
Vegetation functional attributes are normally filled for each cohort by function `spwbInput()` from species identity. However, different parameters can be specified for different cohort of the same species if desired. Basic functional parameters relate to light extinction, water interception and leaf phenology:

+ $k_{PAR,i}$ [`k`]: PAR extinction coefficient.
+ $s_{water, i}$ [`g`]: Crown water storage capacity (i.e. depth of water that can be retained by leaves and branches) per LAI unit (in $mm H_2O \cdot LAI^{-1}$).
+ $S_{GDD,i}$ [`Sgdd`]: Growth degree days corresponding to leave budburst (in degrees Celsius).

A second set of parameters are related to plant transpiration and photosynthesis.

+ $\Psi_{extract,i}$ [`Psi_extract`]: Soil water potential (in MPa) corresponding to 50% of water extractive capacity.
+ $WUE_{\max,i}$ [`WUE`]: Maximum water use efficiency (in $g C \cdot mm^{-1}$).
+ $K_{rootdisc,i}$ [`pRootDisc`]: Relative conductance of roots that leads to hydraulic disconnection from soil.

## Metereological input
Weather input data must include variables calculated at the **daily** scale.

+ $T_{mean}$ [`MeanTemperature`]: Mean daily temperature (in $^{\circ} \mathrm{C}$).
+ $Rad$ [`Radiation`]: Solar radiation, after accounting for clouds (in $MJ \cdot m^{-2}$), only necessary if snow pack dynamics are simulated (i.e., if \texttt{snowpack = TRUE}).
+ $P$ [`Precipitation`]: Daily precipitation (in $L \cdot m^{-2}$ = mm of water).
+ $PET$ [`PET`]: Daily potential evapotranspiration (in  $L \cdot m^{-2}$ = mm of water), preferably calculated using Penman's equation.

Optionally, the user may also specify values of wind speed ($u$, in m·s$^{-1}$, `WindSpeed`) that are used to control leaf fall in autumn. We recommend meteorological input to be generated using package **meteoland** [@DeCaceres2018].

## Control parameters
Control parameters are a list of parameter values, initialized using function `defaultControl()`, that the user can modify to change the general behavior of the model. The control values relevant for the simple water balance model are:

+ `verbose [=TRUE]`: Whether extra console output is desired during simulations.
+ `soilFunctions [= "SX"]`: Water retention curve model, either "SX" (for Saxton) or "VG" (for Van Genuchten).
+ `snowpack [= TRUE]`:  Whether dynamics of snow pack are included.
+ `drainage [= TRUE]`:  Whether water exceeding the field capacity of the bottom layer is lost by deep drainage into a non-reachable compartment.
+ `transpirationMode [= "Granier"]`: Transpiration model, in this case "Granier".
+ `defaultWindSpeed [= 5]`: Default value for wind speed (in $m \cdot s^{-1}$) when this is missing (only used for leaf fall).
+ `cavitationRefill [= TRUE]`: If `FALSE` the model operates in a irreversible cavitation mode.

## Model output
Function `spwb` returns a list object whose elements are data tables. Each table has dates as rows and has different output variables:

+ `WaterBalance`: Components of the climatic and soil daily water balance (i.e. net precipitation, infiltration, runoff, plant transpiration...).
+ `Soil`: Daily variation of soil variables  (volume, moisture relative to field capacity, water potential) for soil layers.
+ `PlantLAI`: Daily leaf area index for each plant cohort.
+ `PlantTranspiration`: Daily transpiration (in mm) for each plant cohort.
+ `PlantPhotosynthesis`: Daily net photosynthesis (in g C·m-2) for each plant cohort.
+ `PlantPsi`: Daily water potential of each plant (in MPa).
+ `PlantStress`: Daily stress level suffered by each plant cohort (relative whole-plant conductance).

# Details of processes

## Leaf phenology and leaf fall

Given a base temperature ($T_{base} = 5^{\circ} \mathrm{C}$), the growth degree days ($GDD$) are zero for all those days where mean temperature $T_{mean}$ is below $T_{base}$ and start increasing when temperatures become warmer than this threshold. In other words, the $GDD$ function accumulates $\max(0.0, T_{mean} - T_{base})$ for all days previous to the current one. At the end of a year the cummulative value is set again to zero. Plant species can have either evergreen or winter-deciduous phenology. Evergreen plants maintain constant leaf area over the year, whereas in deciduous plants leaf-phenological status is updated daily, represented by $\phi_i$, the fraction of maximum leaf area. Leaf area index (LAI) values of deciduous plants are adjusted for leaf phenology following [@Prentice1993; @Sitch2003]:

\begin{equation}
LAI_{i}^{\phi}=LAI^{live}_i\,\cdot\phi_i
\end{equation}

Budburst occurs when daily temperature exceeds $T_{base}$ and $\phi_i$ increases
linearly from 0 to 1 as function of the degree days above $T_{base}$, until a the
value $S_{GDD,i}$ is reached (i.e. until $GDD > S_{GDD,i}$). In autumn, $\phi_i$
drops to 0 when average daily temperature falls again below $T_{base}$ [@Sitch2003]. The drop of $\phi_i$ causes live expanded leaves to become dead leaves. To avoid a sudden decrease of leaf area, dead leaves are kept in the canopy and they are reduced daily using a negative exponential function of wind speed:
\begin{equation}
LAI^{dead}_i=LAI^{dead}_i\,\cdot e^{- u/10}
\end{equation}
where $u$ is wind speed in (m·s$^{-1}$).

After updating the leaf area of each cohort, the model updates the total leaf area of the stand. To simplify the notation, let us call $LAI^{all}_{i}$ the sum of dead and live expanded leaves of a cohort $i$:
\begin{equation}
LAI^{all}_{i} = LAI^{\phi}_{i}+LAI^{dead}_{i}
\end{equation}
If there are $c$ plant cohorts, the leaf area index of the whole stand, $LAI_{stand}$
is then:
\begin{equation}
LAI_{stand} = \sum_{i=1}^c{LAI_{i}^{all}}= \sum_{i=1}^c{LAI^{\phi}_{i}+LAI^{dead}_{i}}
\end{equation}

Although simulations will normally start in winter and $GDD$ will be zero at the beginning, the user can specify a starting non-zero value for $GDD$ in the object created by function \texttt{spwbInput()}.

## Light extinction
The proportion of photosynthetic active radiation (PAR) decreases with leaf area following thee Beer-Lambert’s light extinction equation. To calculate the proportion of PAR available for a given plant cohort one must accumulate the light extinction caused by cohorts whose crown is above that of the target cohort:
\begin{equation}
L^{PAR}_i=e^{-\sum_{h=1}^{c}{k_{PAR,h} \cdot LAI_{h}^{all} \cdot p_{ih}}}
\end{equation}
where $k_{PAR,h}$ is the PAR extinction coefficient of cohort $h$. Because plant
cohorts may differ in height only slightly, leaf area is multiplied by $p_{ih}$,
the proportion of the crown of cohort $h$ that overtops that of cohort $i$: 
\begin{equation}
p_{ih}=\max(0,\min(1,(H_h-H_i\cdot (1 - CR_i))/(H_h-H_h\cdot (1 - CR_h))))
\end{equation}
where $CR_i$ and $CR_h$ are the crown ratio of cohorts $i$ and $h$. In other terms,
cohorts whose crown is completely above that of $i$ reduce the amount of light
available more strongly by than cohorts that are only slightly taller.
$L^{PAR}_{ground}$, the proportion of PAR that reaches the ground, is calculated as:
\begin{equation}
L^{PAR}_{ground}=e^{-\sum_{i=1}^{c}{k_{PAR,i} \cdot LAI_{i}^{all}}}
\end{equation}

The shortwave radiation (SWR; 400-3000 nm) energy absorbed by each plant cohort
needs to be calculated to determine plant transpiration, and the radiation absorbed
by the soil is needed to calculate soil evaporation. Foliage absorbs a higher
proportion of PAR than SWR; thus, the extinction coefficient is higher for PAR
than for SWR. However, values for the ratio of extinction coefficients are rather
constant. Following Friend et al. [-@Friend1997] here it is assumed that the extinction
coefficient for PAR is 1.35 times larger than that for SWR (i.e.
$k_{SWR,i} = k_{PAR,i}/1.35$). 

To calculate radiation absorption, where the vertical dimension of the plot is
divided into 1 m deep layers, and the SWR absorbed is calculated for each plant
cohort in each layer. Let $n$ be the number of canopy layers. The fraction of
radiation incident on layer $j$ that is absorbed in the same layer is:
\begin{equation}
f_j=1 - e^{-\sum_{i=1}^{c}{k_{SWR,i} \cdot LAI_{i,j}^{all}}}
\end{equation}
where $LAI_{i,j}^{all} = LAI_{i,j}^{\phi}+LAI_{i,j}^{dead}$ is the leaf area
index of cohort $i$ in layer $j$. Hence, the fraction transmitted is $(1-f_j)$.
The fraction of radiation incident on layer $j$ that is absorbed by expanded leaves
of plant cohort $i$ in that layer ($f_{ij}$) is calculated from the relative
contribution of these leaves to the total absorption in the layer:
\begin{equation}
f_{ij} = f_j \cdot \frac{k_{SWR,i}\cdot LAI_{i,j}^{\phi}}{\sum_{h=1}^{c}{k_{SWR,h} \cdot LAI_{h,j}^{all}}}
\end{equation}
The fraction of canopy radiation absorbed by a plant cohort $i$ across all layers
is found by adding the fraction absorbed in each layer:
\begin{equation}
f_i = \sum_{j=1}^{n}{f_{ij}\cdot \prod_{h>j}^{n}{(1-f_h)}}
\end{equation}
where for each layer the fraction of the radiation incident in the canopy that
reaches the layer is found by multiplying the transmitted fractions across the
layers above it. The proportion of (shortwave) net radiation absorbed by the
ground is simply:
\begin{equation}
L^{SWR}_{ground} = 1 - \sum_{j}^{n}{f_j}
\end{equation}


\subsection{Snow pack dynamics}
Precipitation is considered be snow when $T_{mean}<0$. Interception of snow by the canopy is neglected, and all snow is assumed to accumulate in a single storage compartment $S_{snow}$ over the soil (i.e. canopy snow storage capacity is neglected). A very simple snow submodel is used for snow pack dynamics (accumulation and melt), taken from @Kergoat1998. When mean air temperature is above 0 Celsius $T_{mean}>0$, a simple energy budget relates snow melt, $Sm$ (mm), to air temperature and soil-level radiation (see function \texttt{hydrology\_snowMelt}):
\begin{equation}
Sm = \frac{Rad\cdot L^{SWR}_{ground}\cdot (1-\alpha_{ice}) + \tau_{day} \cdot T_{mean} \cdot \rho \cdot C_p/r_{s}}{\lambda_{ice}}
\end{equation}
where $Rad$ is solar radiation (MJ·m$^{-2}$), $L^{SWR}_{ground}$ is the fraction of (short-wave) radiation reaching the ground, $\alpha_{ice} = 0.9$ is the albedo of snow, $\tau_{day} = 86400$ is the day duration in s, $\rho$ is the air density (depending on temperature and elevation), $C_{p} = 1013.86 \cdot 10^{-6}$ MJ·kg$^{-1}$·C$^{-1}$ is the specific heat capacity of the air and $r_{s} = 100$ s·m$^{-1}$ is the snow aerodynamic resistance and $\lambda_{ice} = 0.33355$MJ·kg is the (latent) heat of fusion of snow.

## Rainfall interception loss

Interception loss is only modelled for water precipitation (i.e. snow interception is not modelled). Rainfall interception loss, $In$, is estimated using the @Gash1995 analytical interception model for sparse canopies, where rain is assumed to fall in a single event during the day. First, the amount of rainfall needed to saturate the canopy is calculated: 
\begin{equation}
P_G = - \frac{S/C}{(E/R)} \cdot \ln(1-(E/R))
\end{equation}
where $S$ is the canopy water storage capacity (in mm) –  i.e. the minimum amount
of water needed to saturate the canopy –, $C$ is the canopy cover and $(E/R)$ is
the ratio of evaporation rate to rainfall rate during the rainfall event.
Simplifying assumptions are made to determine $(E/R)$. Values of the Evaporation-to-rainfall ratio are calculated from daily potential evapotranspiration and rainfall, while accounting for seasonal variation in rainfall intensity (mm/h). Minimum values for rainfall intensity are assumed for convective storms (5.6 mm/h) and synoptic storms (1.5 mm/h) from @Miralles2010. Synoptic storms are assumed between December and June, and convective storms are assumed for the remaining months, as typical in the Mediterranean Basin.

The amount of water evaporated from interception, $I$ (mm), is calculated as:
\begin{eqnarray}
In = C\cdot P_G+C\cdot(E/R)\cdot(P-P_G) \: {if}\: P > P_G \\
In = C\cdot P\: {if}\: P \leq P_G
\end{eqnarray}
where $P$ is the daily gross precipitation (in mm). Net rainfall, $Pr_{net}$, is
calculated as the difference between gross rainfall and interception loss.
Although interception models are normally applied to single-canopy stands, we
apply the sparse Gash model to the whole stand (including shrubs). Moreover, in
our implementation stem interception is lumped with canopy interception, so that
$S$ represents both. Following @Watanabe1996 we estimate $S$, the
canopy water storage capacity, from adjusted LAI values:
\begin{equation}
S=\sum_{i}{s_{water,i}\cdot LAI_{i}^{\phi}}
\end{equation}
where $s_{water,i}$ is the depth of water that can be retained by leaves and
trunks of a  species $i$ per unit of leaf area index (mm·LAI$^{-1}$). To estimate
the stand cover, $C$, we use the complement of the percentage of PAR that reaches
the ground, i.e. $C = 1 - L^{PAR}_{ground}$ [@Deguchi2006]. Fig. 1 below
shows examples of relative throughfall, calculated according to the interception
model, under different situations (see function `hydrology_rainInterception()`). 

```{r, echo=FALSE, fig.width=7, fig.height=7,  fig.cap="Examples of canopy interception with different S (canopy water storage capacity), E/R (ratio between evaporation and rainfall rates) and p (throughfall coefficient; p = 1 - C)"}
par(mfrow=c(2,2), mar=c(5,5,5,1))
throughfallMatrixGash<-function(P = seq(1,50, by=1), Cm = seq(1,5, by=1), ER = 0.08,p=0.8) {
  m2<-P-hydrology_rainInterception(P,Cm[1],p,ER=ER)
  for(i in 2:length(Cm)) {
    m2<-rbind(m2,P-hydrology_rainInterception(P,Cm[i],p,ER=ER))
  }
  colnames(m2)<-P
  rownames(m2)<-Cm
  return(m2)
}

Cm = c(0.5,seq(1,4, by=1))
P = seq(1,50, by=1)

m2 = throughfallMatrixGash(P=P, p=0.2, Cm=Cm,ER = 0.05)
rt = sweep(m2,2,P,"/")*100
matplot(t(rt), type="l", axes=TRUE, ylab="Relative throughfall (%)", 
        xlab="Gross rainfall (mm)", xlim=c(0,length(P)), 
        lty=1:length(Cm), col="black", ylim=c(0,100))
title(main="p = 0.2 E/R = 0.05")
m2 = throughfallMatrixGash(P=P, p=0.8, Cm=Cm,ER = 0.05)
rt = sweep(m2,2,P,"/")*100
matplot(t(rt), type="l", axes=TRUE, ylab="Relative throughfall (%)", 
        xlab="Gross rainfall (mm)", xlim=c(0,length(P)), 
        lty=1:length(Cm), col="black", ylim=c(0,100))
title(main="p = 0.8 E/R = 0.05")
m2 = throughfallMatrixGash(P=P, p=0.2, Cm=Cm,ER = 0.2)
rt = sweep(m2,2,P,"/")*100
matplot(t(rt), type="l", axes=TRUE, ylab="Relative throughfall (%)", 
        xlab="Gross rainfall (mm)", xlim=c(0,length(P)), 
        lty=1:length(Cm), col="black", ylim=c(0,100))
title(main="p = 0.2 E/R = 0.2")
m2 = throughfallMatrixGash(P=P, p=0.8, Cm=Cm,ER = 0.2)
rt = sweep(m2,2,P,"/")*100
matplot(t(rt), type="l", axes=TRUE, ylab="Relative throughfall (%)", 
        xlab="Gross rainfall (mm)", xlim=c(0,length(P)), 
        lty=1:length(Cm), col="black", ylim=c(0,100))
title(main="p = 0.8 E/R = 0.2")

legend("bottomright",lty=1:length(Cm), legend=paste("S =",Cm), bty="n")
```



## Runoff, infiltration and percolation

The water that reaches the soil is the sum of net rainfall ($Pr_{net}$), runon ($Ro$) and melted snow ($Sm$). The amount of water infiltrating into the soil is $Pr_{net} + Sm + Ro - Ru$, where $Ru$ is the water lost by surface runoff (see function \texttt{hydrology\_infiltrationAmount}). Surface runoff (in mm), is calculated using the USDA SCS curve number method, as in @Boughton1989:
\begin{equation}
Ru=\frac{(Pr_{net} + Ro + Sm - 0.2 \cdot V_{soil})^2}{(Pr_{net} + Ro + Sm - 0.8 \cdot V_{soil})}
\end{equation}
where $V_{soil}$ (in mm) is the overall soil water retention capacity. Following @Granier1999, part of the water reaching one soil layer percolates quickly through the macropores. The amount of water reaching each layer through macropores is modelled using an extinction function (see function `hydrology_infiltrationRepartition`). The remaining water is retained by the micropores refilling the current soil layer. When this soil layer reaches its field capacity the excess of water also percolates to the soil layer below. 

```{r, fig.width=8, fig.height=4, echo=FALSE, fig.cap="Examples of infiltration/runoff calculation for different values of net rainfall and overall retention capacity, $V_{soil}$, calculated from different soil depths (topsoil+subsoil) and assuming that soil texture is 15% clay and 25% sand. Rock fragment content was 25% and 40% for the topsoil and subsoil, respectively."}
par(mfrow=c(1,2), mar=c(5,5,5,1))

SoilDepth = c(200,400,800,1200,1500)

#TOPSOIL LAYERS
d1 = pmin(SoilDepth, 300) #<300
#SUBSOIL LAYERS
d2 = pmax(0, pmin(SoilDepth-300,1200)) #300-1500 mm
#ROCK LAYER
d3 = 4000-(d1+d2) #From SoilDepth down to 4.0 m

TS_clay = 15
TS_sand = 25
SS_clay = 15
SS_sand = 25
RL_clay = 15
RL_sand = 25
TS_gravel = 20
SS_gravel = 40
RL_gravel = 95

Theta_FC1=soil_psi2thetaSX(TS_clay, TS_sand, -33) #in m3/m3
Theta_FC2=soil_psi2thetaSX(SS_clay, SS_sand, -33) #in m3/m3
Theta_FC3=soil_psi2thetaSX(RL_clay, RL_sand, -33) #in m3/m3
pcTS_gravel = 1-(TS_gravel/100)
pcSS_gravel = 1-(SS_gravel/100)
pcRL_gravel = 1-(RL_gravel/100)
MaxVol1 = (d1*Theta_FC1*pcTS_gravel)
MaxVol2 = (d2*Theta_FC2*pcSS_gravel)
MaxVol3 = (d3*Theta_FC3*pcRL_gravel)
V = MaxVol1+MaxVol2+MaxVol3

par(mar=c(5,5,1,1), mfrow=c(1,2))
NP = seq(0,60, by=1)
plot(NP,hydrology_infiltrationAmount(NP, V[1]), type="l", xlim=c(0,60), ylim=c(0,60), 
     ylab="Infiltration (mm)", xlab="Net rainfall (mm)", frame=FALSE)
lines(NP,hydrology_infiltrationAmount(NP, V[2]), lty=2)
lines(NP,hydrology_infiltrationAmount(NP, V[3]), lty=3)
lines(NP,hydrology_infiltrationAmount(NP, V[4]), lty=4)
lines(NP,hydrology_infiltrationAmount(NP, V[5]), lty=5)
legend("topleft", bty="n", lty=1:5, legend=c(paste("d =", SoilDepth, "Vsoil =",round(V),"mm")))
plot(NP,NP-hydrology_infiltrationAmount(NP, V[1]), type="l", xlim=c(0,60), ylim=c(0,60), 
     ylab="Runoff (mm)", xlab="Net rainfall (mm)", frame=FALSE)
lines(NP,NP-hydrology_infiltrationAmount(NP, V[2]), lty=2)
lines(NP,NP-hydrology_infiltrationAmount(NP, V[3]), lty=3)
lines(NP,NP-hydrology_infiltrationAmount(NP, V[4]), lty=4)
lines(NP,NP-hydrology_infiltrationAmount(NP, V[5]), lty=5)
legend("topleft", bty="n", lty=1:5, legend=c(paste("d =", SoilDepth,"Vsoil =",round(V),"mm")))
```

If `drainage = TRUE`, the water percolating from the lowest layer is considered deep drainage, $Dd$, and soil layers are never above field capacity. If `drainage = FALSE`, the excess of water in the lowest soil layer is not lost via drainage, so that this layer (and those above) can be filled up to saturation. This additional filling is done starting from below, and when a given layer reaches saturation, the model adds the remaining water to the layer above. If all layers are filled to saturation, the remaining water is assumed to be infiltration excess and is added to the surface runoff. 

## Bare soil evaporation
Evaporation from the soil surface is the last component of the soil water balance to be calculated. There is a difference in the way that soil evaporative demand is calculated depending on the transpiration mode. Potential evaporation from the soil ($PE_{soil}$; in $mm\cdot day^{-1}$) is defined as the product between $PET$ and $L^{SWR}_{ground}$, the proportion of SWR absorbed by the ground:
\begin{equation}
PE_{soil} =  PET\cdot L^{SWR}_{ground}
\end{equation}

Actual evaporation from the soil surface is modeled as in @Mouillot2001, who
followed @Ritchie1972.  First, the model determines the time needed to evaporate
the current water deficit (difference between field capacity and current moisture)
in the surface soil layer:
\begin{equation}
t = \left \{ \frac{V_1\cdot(1- W_1)}{\gamma_{soil}} \right \}
\end{equation}
where $\gamma_{soil}$ is the maximum daily evaporation (mm·day$^{-1}$). The
calculated time is used to determine the ‘supplied’ evaporation, $SE_{soil}$:
\begin{equation}
SE_{soil} = \gamma_{soil} \cdot (\sqrt{t+1}-\sqrt{1})
\end{equation}
The amount of water evaporated from the soil, $E_{soil}$, is then calculated as
the minimum between supply and demand [@Federer1982], the latter being the product
of PET and the proportion of light that reaches the ground (see function `hydrology_soilEvaporationAmount`): 

\begin{equation}
E_{soil} = \min(PE_{soil}, SE_{soil})
\end{equation}

Finally, $E_{soil}$ is distributed along the soil profile according to an exponential decay function with an extinction coefficient $\kappa_{soil}$ [@Mouillot2001].

```{r, fig.width=4, fig.height=4, echo=FALSE, fig.cap="Cumulative bare soil evaporation for different values of maximum evaporation rate and extinction coefficient. Three soil layers (0 – 30 cm; 30 – 150 cm; 150 – 400 cm) are initialized at field capacity ($V_1 = 50 mm$; $V_2 = 201 mm$; $V_3 = 35 mm$). $PE_{soil}$ was assumed not to be limiting. When the extinction coefficient is smaller a higher proportion of the evaporated water is removed from the subsoil and less from the topsoil. This causes more water being available to calculate t in the next step."}

TS_clay=10
TS_silt=65
TS_sand=25
TS_gravel=40
SS_clay=10
SS_silt=65
SS_sand = 25
SS_gravel=40
TS_macro=0.25
TS_micro = 0.75
SS_macro=0.10
SS_micro=0.90
#Rock layer is like subsoil but with 95% of rocks
RL_clay = SS_clay
RL_sand = SS_sand
RL_macro = SS_macro
RL_micro = SS_micro
RL_gravel = 95


RunEvaporation<-function(Gsoil, Ksoil, d1,d2,d3, numDays = 15){
  PET = 100 #Not limited by PET
  Lground = 1
  
  Theta_FC1=soil_psi2thetaSX(TS_clay, TS_sand, -33) #in m3/m3
  Theta_FC2=soil_psi2thetaSX(SS_clay, SS_sand, -33) #in m3/m3
  Theta_FC3=soil_psi2thetaSX(RL_clay, RL_sand, -33) #in m3/m3
  pcTS_gravel = 1-(TS_gravel/100)
  pcSS_gravel = 1-(SS_gravel/100)
  pcRL_gravel = 1-(RL_gravel/100)
  MaxVol1 = (d1*Theta_FC1*pcTS_gravel)
  MaxVol2 = (d2*Theta_FC2*pcSS_gravel)
  MaxVol3 = (d3*Theta_FC3*pcRL_gravel)
  Ssoil = MaxVol1 + MaxVol2 + MaxVol3

  W1=rep(0, numDays)
  W2=rep(0, numDays)
  W3=rep(0, numDays)
  W1[1] = 1
  W2[1] = 1
  W3[1] = 1
  Esoil = rep(NA,numDays)
  EsoilCum = rep(NA,numDays)
  t = rep(NA, numDays)
  for(i in 1:numDays){
    #Evaporation from bare soil
    Esoil[i] = hydrology_soilEvaporationAmount(DEF=(MaxVol1*(1 - W1[i])), PETs = PET*Lground, Gsoil = Gsoil)
    if(i==1) EsoilCum[i] = Esoil[i]
    else EsoilCum[i] = EsoilCum[i-1]+Esoil[i]
    #Exponential decay to divide bare soil evaporation among layers
    Esoil1 = Esoil[i]*(1-exp(-Ksoil*d1))
    Esoil2 = Esoil[i]*(exp(-Ksoil*d1)-exp(-Ksoil*(d1+d2)))
    Esoil3 = Esoil[i]*(exp(-Ksoil*(d1+d2)))
    if(i<numDays){
      W1[i+1] = max(W1[i]-(Esoil1)/MaxVol1,0)
      W2[i+1] = max(min(W2[i]-(Esoil2)/MaxVol2,1),0)
      W3[i+1] = max(min(W3[i]-(Esoil3)/MaxVol3,1),0)
    }  
  }
  return(list(Esoil = Esoil, EsoilCum = EsoilCum))  
}

E11=RunEvaporation(Gsoil=1, Ksoil = 0.05, d1=300, d2=1200, d3= 2500)
E12=RunEvaporation(Gsoil=2, Ksoil = 0.05, d1=300, d2=1200, d3= 2500)
E13=RunEvaporation(Gsoil=3, Ksoil = 0.05, d1=300, d2=1200, d3= 2500)
E21=RunEvaporation(Gsoil=1, Ksoil = 0.005, d1=300, d2=1200, d3= 2500)
E22=RunEvaporation(Gsoil=2, Ksoil = 0.005, d1=300, d2=1200, d3= 2500)
E23=RunEvaporation(Gsoil=3, Ksoil = 0.005, d1=300, d2=1200, d3= 2500)


par(mar=c(4,4,1,1))
plot(x=1:length(E11$EsoilCum), y=E11$EsoilCum, ylim=c(0,15), ylab="Cummulative soil evaporation (mm)", xlab="day", type="l", axes=FALSE)
axis(1, at=1:length(E11$EsoilCum), cex.axis=0.7)
axis(2)
points(x=1:length(E11$EsoilCum), y=E11$EsoilCum, pch=1)
lines(x=1:length(E12$EsoilCum), y=E12$EsoilCum, lty=2)
points(x=1:length(E12$EsoilCum), y=E12$EsoilCum, pch=1)
lines(x=1:length(E13$EsoilCum), y=E13$EsoilCum, lty=3)
points(x=1:length(E13$EsoilCum), y=E13$EsoilCum, pch=1)
lines(x=1:length(E21$EsoilCum), y=E21$EsoilCum, lty=1)
points(x=1:length(E21$EsoilCum), y=E21$EsoilCum, pch=2)
lines(x=1:length(E22$EsoilCum), y=E22$EsoilCum, lty=2)
points(x=1:length(E22$EsoilCum), y=E22$EsoilCum, pch=2)
lines(x=1:length(E23$EsoilCum), y=E23$EsoilCum, lty=3)
points(x=1:length(E23$EsoilCum), y=E23$EsoilCum, pch=2)
legend("topleft", lty=rep(1:3,2), pch=c(1,1,1,2,2,2), legend=c("Gsoil = 1 Ksoil = 0.05", 
                                    "Gsoil = 2 Ksoil = 0.05", 
                                    "Gsoil = 3 Ksoil = 0.05",
                                    "Gsoil = 1 Ksoil = 0.005", 
                                    "Gsoil = 2 Ksoil = 0.005", 
                                    "Gsoil = 3 Ksoil = 0.005"), cex = 0.7, bty="n")
```


## Plant transpiration and photosynthesis
### PET and maximum canopy transpiration

In this model daily potential evapotranspiration ($PET$; in mm·day$^{-1}$; the amount of evaporation that would occur if a sufficient water source was available) is part of the meteorological input and has to be calculated externally. $PET$ is assumed to represent open water evaporation potential (like in Penman's formula). Maximum canopy transpiration $Tr_{\max}$ not only depends on $PET$ but also on the amount of transpirating surface. To estimate $Tr_{\max}$ we take the approach of @Granier1999, where $Tr_{\max}/PET$ is a function of $LAI_{stand}$ – the cumulative leaf area of the forest stand –, according to the empirical equation:
\begin{equation}
\frac{Tr_{\max}}{PET}= -0.006\,LAI_{stand}^2+0.134\,LAI_{stand}+0.036
\end{equation}
This equation has already been adopted for Mediterranean biomes (Fyllas and
Troumbis, 2009; Ruffault et al., 2013). 
```{r, fig.width=4, fig.height=4, fig.align = "center", echo=FALSE, fig.cap="Empirical relationship between $Tr_max/PET$ and $LAI_{stand}$"}
par(mar=c(4,4,1,1))
LAIc = seq(0,10, by=0.01)
TmaxPET = -0.006*(LAIc^2) + 0.134*LAIc + 0.036
plot(LAIc, TmaxPET, type="l", ylab="Tr_max/PET", xlab="LAIstand", ylim=c(0,1))
```

The maximum transpiration for a given plant cohort $i$ is calculated as the
portion of $Tr_{\max}$ defined by the fraction of total absorbed SWR that is due
to cohort $i$:
\begin{equation}
Tr_{\max, i} = Tr_{\max} \cdot \frac{f_i}{\sum_{j}{f_j}}
\end{equation}

### Actual plant transpiration
Actual plant transpiration depends on soil moisture and is calculated for each plant cohort and each soil layer separately. $Tr_{i,s}$ (in mm·day$^{-1}$) represents the transpiration made by cohort $i$ from layer $s$. Actual plant transpiration from a given layer is regulated by soil moisture and the resistance to water flow through the plant. For each plant cohort $i$ and soil layer $s$, the model first estimates the a whole-plant relative water conductance, $K_{i,s}$, which varies between 0 and 1 depending on $\Psi_{extract,i}$, the potential at which conductance is 50% of maximum, and $\Psi_s$, the water potential in layer $s$ (see function `hydraulics_psi2K()`):
\begin{equation}
K_{i,s}=K_{i}(\Psi_s) = \exp \left \{\ln{(0.5)}\cdot \left[ \frac{\Psi_s}{\Psi_{extract,i}} \right] ^r \right \} 
\end{equation}
where $r$ is an exponent that modulates the steepness of the decrease in relative
conductance when soil potential becomes negative (by default, $r = 3$) and $\ln(0.5)$
is used to ensure that $K_{i}(\Psi_{extract,i}) = 0.5$ (Fig. 4).
```{r, fig.width=3.5, fig.height=3.5, fig.align="center", echo=FALSE, fig.cap="Whole-plant relative water conductance functions for different water potential values ($r = 3$ in all cases)."}
par(mar=c(4,4,1,1))
x = seq(-10, 0, by=0.01)
plot(-x ,unlist(lapply(x,hydraulics_psi2K,-2.0,3.0)), type="l", ylab="K (relative conductance)", xlim=c(0,10), ylim=c(0,1),xlab="Soil water potential (-MPa)", frame=FALSE)
lines(-x, unlist(lapply(x,hydraulics_psi2K,-3.0,3.0)), lty=2)
lines(-x, unlist(lapply(x,hydraulics_psi2K,-4.0,3.0)), lty=3)
lines(-x, unlist(lapply(x,hydraulics_psi2K,-5.0,3.0)), lty=4)
legend("topright", lty=1:4, col=c(rep("black",4)), 
       legend = paste("Psi_extract = ", c(-2.0,-3.0,-4.0, -5.0), "MPa"), bty="n", cex=0.8)
abline(h=50, col="gray", lwd=2)
```

Actual transpiration of plant cohort $i$ from a given soil layer $s$, $Tr_{i,s}$,
is defined as the product of (Mouillot et al., 2001): (i) the maximum transpiration
of the plant cohort; (ii) the relative whole-plant conductance, $K_{i,s}$,
corresponding to the species and water potential in layer $s$; (iii) the
proportion of plant fine roots in layer $s$, $v_{i,s}$:
\begin{equation}
Tr_{i,s} =  Tr_{\max,i} \cdot K_{i,s} \cdot v_{i,s}
\end{equation}
The total amount of water transpired by plants, $Tr$ (in mm·day$^{-1}$), is the sum of
$Tr_{i,s}$ values over all plant cohorts and soil layers:
\begin{equation}
Tr =\sum_{s}\sum_{i}{Tr_{i,s}}
\end{equation}
Assuming no water limitations (i.e. $K_{i,s} = 1$), we have that $Tr = Tr_{\max}$.
Total stand transpiration will be lower than $Tr_{\max}$ if soil water potential
in any layer is negative enough to cause a significant reduction in whole-plant
conductance. At the plant level, the transpiration of a given plant cohort will
be lower than that of others if: (1) the cohort is under the shade (it reduces
$f_i$ and hence $Tr_{\max,i}$); (2) the cohort has a lower amount of leaf area
(it reduces $f_i$ and hence $Tr_{\max,i}$); (3) the soil layers exploited by the
cohort have more negative water potentials (it reduces $K_{i,s}$). 


### Plant photosynthesis

Because it is useful for growth and forest dynamics, and for compatibility with
the 'Sperry' transpiration mode, the 'Granier' transpiration mode also calculates
net assimilated carbon. Assuming a constant maximum water use efficiency (WUE),
photosynthesis for a given plant cohort $i$ (in g C · m$^{-2}$ · day$^{-1}$) is
estimated as a function of transpiration [@Mouillot2001]:
\begin{equation}
A_n = \alpha \cdot WUE_{\max} \cdot Tr_i
\end{equation}
where $Tr_i$ is the transpiration of plant cohort $i$, $WUE_{\max}$ is the
maximum water use efficiency of the corresponding species (in g C · mm$^{-1}$)
and $\alpha = T_{mean}/20$ is bounded between 0 and 1.

\subsubsection{Plant drought stress and plant water potential}

Similarly to @Mouillot2002, daily drought stress of a given plant cohort
$i$, $DDS_i$, is defined as the complement of relative whole-plant conductance and
is aggregated across soil layers using the proportion of fine roots in each layer
as weights:
\begin{equation}
DDS_i=\phi_i \cdot \sum_{s}{(1-K_{i,s})\cdot v_{i,s}}
\end{equation}
Leaf-phenological status is included to prevent winter deciduous plants from
suffering drought stress during winter. Daily drought stress values can be later
used to define drought stress indices for larger temporal scales, as presented in
the main text.

Granier's transpiration model does not allow estimating a water potential drop
from soil to the leaf. Moreover, in a multilayered soil it is difficult to know
what would be the water potential of the plant. Despite these limitations, a
gross surrogate of (pre-dawn) 'leaf water potential' ($\Psi_{leaf,i}$; in MPa) may be
obtained averaging whole-plant relative conductance values:
\begin{equation}
\Psi_{leaf,i}=K^{-1}(K_i) = K^{-1}\left(\sum_{s}{K_{i,s}\cdot v_{i,s}}\right)
\end{equation}
where $K_i$ is the average whole-plant relative conductance obtained from the
scalar product of conductances and fine root proportions and $K^{-1}$ is the inverse of the whole-plant conductance function (see function `hydraulics_K2Psi()`). 

### Irreversible cavitation and hydraulic disconnection
The water balance model is normally run assuming that although soil drought may
reduce transpiration, embolized xylem conduits are automatically refilled when
soil moisture recovers (in other words, cavitation is reversible). It is possible
to simulate irreversible cavitation by setting `cavitationRefill = FALSE` in the control parameters. This option causes the model to keep track of the maximum value of drought stress so far experienced:
\begin{equation}
P_{embolized,i}= \max \{P_{embolized,i}, DDS_i \}
\end{equation}
and then $K_{i,s}$ cannot be larger than the complement of this maximum drought
stress:
\begin{equation}
K_{i,s} = \min \{K_{i}(\Psi_s), 1.0 - P_{embolized,i} \}
\end{equation}

Another optional behavior consists in allowing the plant to disconnect from the
soil when its potential becomes too negative. This may be advantageous for a
cavitation-sensitive plant that is competing for water with another plant with
higher extraction capacity. Parameter $K_{rootdisc,i}$ can be used to specify the
minimum relative conductance value that the plant will tolerate without
disconnecting hydraulically from the soil (by default $K_{rootdisc,i} = 0$).
If, after possibly accounting for irreversible cavitation, $K_{i,s}<K_{rootdisc,i}$
for a given soil layer, then the model assumes that transpiration from this soil
layer is absent. Moreover, $K_{i,s}$ is assumed equal to $K_{rootdisc,i}$ for the
sake of determining plant water potential. 

# References

