# Plant hydraulics


The supply-loss theory of plant hydraulics, presented by @Sperry2016 and used in @Sperry2016, uses the physics of flow through soil and xylem to quantify how steady-state canopy water supply declines with drought and ceases by hydraulic failure. The theory builds on the  hydraulic model of @Sperry1998 and can be applied to different segmentations of the soil-plant continuum. In our case we considered a network of $(N \times 2 + S + 1)$ resistance elements, with soil being represented in $N$ different layers and $S$ different stem segments. For each soil layer there is a rhizosphere element in series with a root xylem element. The $N$ soil layers are in parallel up to the root crown. From there there are $S$ stem xylem segments and a final leaf segment, all in series. Althougth the model implements this network representation of the soil-plant continuum, simpler one-element, two-element and three-element representations will be used in this document to facilitate understanding.


## Vulnerability curves
Each continuum element has a vulnerability curve that starts at maximum hydraulic conductance ($k_{max}$, flow rate per pressure drop) and monotonically declines as water pressure ($\Psi$) becomes more negative. Vulnerability curves form the basis of hydraulic calculations.

### Xylem vulnerability curves
Xylem tissues are assigned a two-parameter Weibull function as the vulnerability curve $k(\Psi)$:
\begin{equation}\label{eq:xylemvulnerability}
k(\Psi) = k_{max}\cdot e^{-((\Psi/d)^c)}
\end{equation}
where $k_{max}$ is the maximum hydraulic conductance (defined as flow per leaf surface unit and per pressure drop), and $c$ and $d$ are species-specific and tissue-specific parameters. Note that parameter $d$ is the water potential (in MPa) at which $k(\Psi)/k_{max} = e^{-1} = 0.367$. Parameter $c$ controls the shape of the vulnerability curve (‘exponential’ shape with no threshold has $c \leq 1$, sigmoidal threshold has $c > 1$). 

For example, we define the following parameter values for a stem xylem ($k_{s,max}$ and parameters $c_s$ and $d_s$ of the vulnerability curve):
```{r}
kstemmax = 5.0 # mmol·m-2·s-1·MPa-1
stemc = 3 
stemd = -3.0 # MPa
```

For root xylem ($k_{r,max}$), we may assume a higher conductance (i.e. higher efficiency) but also higher vulnerability to cavitation (defined by parameters $c_r$ and $d_r$):

```{r}
krootmax = 6.6 # mmol·m-2·s-1·MPa-1
rootc = 2
rootd = -2.5 #MPa
```

```{r, echo=FALSE}
dE =0.01
Emax = 20
psiVec = seq(-0.1, -7.0, by =-0.01)
```

The concept of vulnerability curve can be used to specify the relationship between pressure and conductance in any portion of the flow path. Leaf vulnerability curve $k_l(\Psi)$ can be modelled using the same equation as for xylem:
\begin{equation}\label{eq:leafvulnerability}
k_l(\Psi) = k_{l,max}\cdot e^{-((\Psi/d_l)^{c_l})}
\end{equation}
where $k_{l,max}$ is the leaf maximum hydraulic conductance. Values defined below specify higher conductance for leaves but also slightly higher vulnerability:
```{r}
kleafmax = 10
leafc = 2
leafd = -2
```


With these parameter values, the vulnerability curves for root, stem and leaf are (see `hydraulics_xylemConductance()`):
```{r, fig.width=5, fig.height=5, fig.align = "center", echo=FALSE}
psiCav = -2.5
plcCav = 1 -moisture_apoplasticRWC(psiCav, stemc, stemd)
par(mar=c(4,4,1,1), mfrow=c(1,1))
kleaf = unlist(lapply(psiVec,hydraulics_xylemConductance, kleafmax, leafc, leafd))
kstem = unlist(lapply(psiVec,hydraulics_xylemConductance, kstemmax, stemc, stemd))
kroot = unlist(lapply(psiVec,hydraulics_xylemConductance, krootmax, rootc, rootd))
plot(-psiVec, kstem, type="l",ylab="Xylem K (mmol·m-2·s-1·MPa-1)", xlab="Canopy pressure (-MPa)", 
     lwd=2,ylim=c(0,max(kstemmax, krootmax, kleafmax)))
lines(-psiVec, kroot, lty=2, lwd=2)
lines(-psiVec, kleaf, lty=3, lwd=2)
# abline(v=-psiCav, col="gray", lwd=1.5)
lines(x=c(0,-psiCav), y=rep(hydraulics_xylemConductance(psiCav, kstemmax, stemc, stemd),2), lty=4, lwd=2)
legend("topright", legend =c("leaf", "stem xylem (original)","stem xylem (cavitation)", "root xylem"), 
       lty=c(3,1,4,2), bty="n", cex=0.8, lwd=2)
```


The dotted line between 0 and $\Psi_{cav} = -2.5$ MPa indicates the modification of the stem xylem vulnerability curve when cavitation has occurred (i.e., previous embolism limits a the maximum conductance value), as indicated in @Sperry2016. The corresponding proportion of conductance loss can be found using the stem vulnerability curve:
\begin{equation}
PLC(\Psi_{cav}) = 1.0 - \frac{k_s(\Psi_{cav})}{k_{s,max}} = 1.0 - e^{-((\Psi/{d_s})^{c_s})}
\end{equation}

```{r}
1.0 - exp(-(-2.5/stemd)^stemc)
```


Although root xylem are  more vulnerable to the formation of emboli for a given potential, it is generally accepted that the less negative potentials of root xylem compared to the stem lead to cavitation occurring more often in the stem. The constrain created by cavitation has an effect on the calculation of the flow rates and derived quantities (see below).


### Rhizosphere vulnerability curve
The rhizosphere conductance function $k_{rh}(\Psi)$ is modeled as a van Genuchten function [@Genuchten1980]:
\begin{eqnarray}
k_{rh}(\Psi) &=& k_{rh,max} \cdot v^{(n-1)/(2\cdot n)} \cdot ((1-v)^{(n-1)/n}-1)^2 \\
v &=& [(\alpha \Psi)^{n}+1]^{-1}
(\#eq:rhizovulnerability)
\end{eqnarray}
where $k_{rh,max}$ is the maximum rhizosphere conductance, and $n$ and $\alpha$ are texture-specific parameters [@Leij1996; @Carsel1988]. These are automatically set by function `soil()` when initializing soil objects (see parameters `VG_alpha` and `VG_n` in the output of `soil()`), but we can use function `soil_vanGenuchtenParamsCarsel()` to derive them from texture types:

```{r}
textures = c("Sandy loam","Silt loam", "Clay")
#Textural parameters
#Sandy clay loam 
p1 = soil_vanGenuchtenParamsCarsel(textures[1])
p1
alpha1 = p1[1]  
n1 = p1[2]
#Silt loam
p2 = soil_vanGenuchtenParamsCarsel(textures[2])
p2
alpha2 =  p2[1]
n2 = p2[2]
#Silty clay
p3 = soil_vanGenuchtenParamsCarsel(textures[3])
p3
alpha3 =  p3[1]
n3 = p3[2]
```


We can estimate maximum rhizosphere conductance values assuming that they account for an average percentage of the resistance (e.g. 15%) across the continuum (see functions `hydraulics_averageRhizosphereResistancePercent()` and `hydraulics_findRhizosphereMaximumConductance()`):

```{r}
percentResistance = 15
#Sandy clay loam 
krmax1 =hydraulics_findRhizosphereMaximumConductance(percentResistance, 
                      n1,alpha1, krootmax, rootc,rootd, kstemmax, stemc, stemd,
                      kleafmax, leafc, leafd)
krmax1
#Silt loam
krmax2 =hydraulics_findRhizosphereMaximumConductance(percentResistance, 
                      n2,alpha2, krootmax, rootc,rootd, kstemmax, stemc, stemd,
                      kleafmax, leafc, leafd)
krmax2
#Silty clay
krmax3 =hydraulics_findRhizosphereMaximumConductance(percentResistance, 
                      n3,alpha3, krootmax, rootc,rootd, kstemmax, stemc, stemd,
                      kleafmax, leafc, leafd)
krmax3
```
With these parameters, the resulting $k_{rh}(\Psi)$ functions can be displayed using the function `hydraulics_vanGenuchtenConductance()`:
```{r,  fig.width=4, fig.height=3.5, echo=FALSE, fig.align = "center"}
par(mar=c(4,4,1,1), mfrow=c(1,1))
k1 = unlist(lapply(psiVec,hydraulics_vanGenuchtenConductance, krmax1, n1, alpha1))
k2 = unlist(lapply(psiVec,hydraulics_vanGenuchtenConductance, krmax2, n2, alpha2))
k3 = unlist(lapply(psiVec,hydraulics_vanGenuchtenConductance, krmax3, n3, alpha3))
plot(-psiVec, k1, type="l", col="black", ylab="Rhizosphere K (mmol·m-2·s-1·MPa-1)", xlab = "Soil hydraulic pressure (-MPa)",  xlim=c(0, max(-psiVec)), ylim=c(0, 100))
lines(-psiVec, k2, lty=2, lwd=1.5)
lines(-psiVec, k3, lty=3, lwd=1.5)
legend("topright", bty="n", legend=textures, lty=1:3, cex=0.8, lwd=1.5)
```


## Water content of plant tissues

In **medfate** the water content of leaves and stems is tracked explicitly. Following @Martin-StPaul2017, we consider two sources of water in plant segments [@Tyree1990]. The first comes from the conduits (tracheids or vessels), which will release water due to cavitation and may be refilled with water from adjacent living tissue. The second source of water is formed by more elastic living cells (i.e. parenchyma) and can potentially be a large source of water during relatively high water potentials. This source can be described using the relative water content of a symplasmic tissue. This storage compartment has its own water potential and exchanges water with the xylem conduits according to the difference in water potential.

### Pressure-volume curves
A pressure-volume curve of a tissue relates a water potential against relative water content ($RWC$; $kg H_2O·kg^{-1}H_2O$ at saturation) in drying tissues. Pressure-volume theory is usually applied to leaves [@Bartlett2012], but it can also be applied to other tissues such as sapwood or cambium cells. 

For living cells, the relationship between $\Psi$ and $RWC$ of the symplasmic fraction ($RWC_{sym}$) is achieved by separating $\Psi$ into osmotic (solute) potential ($\Psi_{S}$) and the turgor potential ($\Psi_{P}$):
\begin{equation}
\Psi = \Psi_{S} + \Psi_{P}
\end{equation}
The relationship for $\Psi_{P}$ is:
\begin{equation}
\Psi_{P} = -\pi_0 -\epsilon\cdot (1.0 - RWC_{sym})
\end{equation}
where $\pi_0$ (MPa) is the osmotic potential at full turgor (i.e. when $RWC_{sym} = 1$), and $\epsilon$ is the modulus of elasticity (i.e. the slope of the relationship). Assuming constant solute content, the relationship for $\Psi_{S}$ is:
\begin{equation}
\Psi_{S} = \frac{-\pi_0}{RWC_{sym}} 
\end{equation}
When $\Psi \leq \Psi_{tlp}$, the water potential at turgor loss point, then $\Psi_{P} = 0$ and $\Psi = \Psi_{S}$. If $\Psi > \Psi_{tlp}$ then the two components are needed. The water potential at turgor loss point ($\Psi_{tlp}$) can be found by [@Bartlett2012]:
\begin{equation}
\Psi_{tlp} = \frac{\pi_0 \cdot \epsilon}{\pi_0 + \epsilon}
\end{equation}
As an example, the following figure draws the pressure-volume curve for a tissue with $\epsilon = 12$ and $\pi_0 = -3.0$MPa:
```{r, fig.width=4, fig.height=4, echo=FALSE, fig.align="center"}
psi = seq(-10,0, by=0.1)
rwc_s = rep(NA, length(psi))
for(i in 1:length(psi)) rwc_s[i] =moisture_symplasticRWC(psi[i],-3,12)
plot(psi, rwc_s, type="l", xlab="Water potential (MPa)", ylab = "Symplasmic RWC")
```

To calculate $RWC_{sym}$ from the water potential of a tissue, the previous equations need to be combined and, after isolating $RWC_{sym}$, a quadratic relationship is obtained. 
  
Apoplastic reservoirs (e.g. sapwood) consist of inelastic cells that release their water to the transpiration stream following embolism. As in @Holtta2009, we equate the relative water content of the apoplastic reservoir of a segment (leaves or stem) to the proportion of maximum conductance in the vulnerability curve:
\begin{equation}
RWC_{apo}(\Psi) = \frac{k(\Psi)}{k_{max}} = e^{-((\Psi/d)^{c})}
\end{equation}

```{r, fig.width=4, fig.height=4, echo=FALSE, fig.align="center"}
psi = seq(-7,0, by=0.1)
rwc_a = rep(NA, length(psi))
for(i in 1:length(psi)) rwc_a[i] =moisture_apoplasticRWC(psi[i],stemc,stemd)
plot(psi, rwc_a, type="l", xlab="Water potential (MPa)", ylab = "Apoplastic RWC")
```


The average relative water content in a given compartment ($RWC$) can be obtained from $\Psi_{sym}$ and $\Psi_{apo}$ by calculating  $RWC_{sym}(\Psi_{sym})$ and $RWC_{apo}(\Psi_{apo})$ followed by assuming a constant apoplastic fraction $f_{apo}$:
\begin{equation}
RWC = RWC_{apo}(\Psi_{apo}) \cdot f_{apo} + RWC_{sym}(\Psi_{sym}) \cdot (1 - f_{apo})
\end{equation}

### Water content and live fuel moisture content

Pressure-volume curves are useful to determine the moisture content of live fuel elements (leaves and twigs). Given an average relative water content of a water compartment, its live fuel moisture content ($LFMC$ in $g H_2O·g^{-1}$ of dry tissue) can be calculated using:
\begin{equation}
LFMC = RWC \cdot \Theta \cdot \frac{\rho_{H_2O}}{\rho} = RWC \cdot LFMC_{max}
\end{equation}
where $\Theta$ is the tissue porosity ($cm^3$ of water per $cm^3$ of tissue), $\rho$ is the density of the tissue and $\rho_{H_2O}$ is the density of water.

If we know $RWC_{apo}(\Psi_{apo})$, the relative water content in conduits, and $V_{segment}$ (in $m^3$), the volume of conducting tissue (sapwood) in the segment, then the mass of water that is stored in conduits is: 
\begin{equation}
S_{apo}(\Psi_{apo}) = V_{segment} \cdot f_{apo} \cdot RWC_{apo}(\Psi_{apo}) \cdot \rho_{w}
\end{equation}
where $\rho_{w}$ is the density of water ($kgH_2O\cdotm^{-3}$) and $f_{apo,s}$ is the volume fraction of apoplastic tissue within sapwood. Similarly, the amount of water stored in the symplastic tissue of the segment at any time is:
\begin{equation}
S_{sym}(\Psi_{sym}) = V_{segment} \cdot (1 - f_{apo}) \cdot RWC_{sym}(\Psi_{sym}) \cdot \rho_{w}
\end{equation}

Finally, if we consider that both apoplastic and symplastic tissues are at the same water potential, the water content in the segment will be:
\begin{equation}
S(\Psi) = V_{segment} \cdot (f_{apo} \cdot RWC_{apo}(\Psi) + (1 - f_{apo}) \cdot RWC_{sym}(\Psi)) \cdot \rho_{w}
\end{equation}

### Relative water content and cavitation

In **medfate** we assume that cavitation in stems is non-reversible. Within a given sapwood segment, we further assume that the proportion of conductance loss ($PLC$) is related to the relative water content ($RWC$) in its conduit vessels (i.e. the water volume in conduit vessels with respect to the maximum water volume):
\begin{equation}
PLC(\Psi_{cav}) = 1 - RWC_{apo}(\Psi_{cav})
\end{equation}
where $RWC_{apo,s}$ is the function of relative water content for apoplastic stem tissue. With this assumption one can relate changes in PLC derived from cavitation with decreases in water content in xylem conduits. When $PLC$ increases the associated change in water content is a source of water can be added to the transpirational stream [@Martin-StPaul2017]. 
