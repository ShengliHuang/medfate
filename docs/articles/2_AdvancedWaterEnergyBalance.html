<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2. Advanced water and energy balance simulation • medfate</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="2. Advanced water and energy balance simulation">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">medfate</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.8.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/0_PackageOverview.html">0. Package overview</a>
    </li>
    <li>
      <a href="../articles/1_BasicWaterBalance.html">1. Basic water balance simulation</a>
    </li>
    <li>
      <a href="../articles/2_AdvancedWaterEnergyBalance.html">2. Advanced water and energy balance simulation</a>
    </li>
    <li>
      <a href="../articles/3_ForestGrowth.html">3. Forest growth simulation</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>2. Advanced water and energy balance simulation</h1>
                        <h4 class="author">Miquel De Caceres</h4>
            
            <h4 class="date">2019-06-04</h4>
      
      
      <div class="hidden name"><code>2_AdvancedWaterEnergyBalance.Rmd</code></div>

    </div>

    
    
<div id="about-this-vignette" class="section level2">
<h2 class="hasAnchor">
<a href="#about-this-vignette" class="anchor"></a>About this vignette</h2>
<p>This document describes how to run a water and energy balance model that uses a more detailed approach for hydraulics and stomatal regulation. This document is meant to teach users to run the simulation model within R. All the details of the model design and formulation are given in a separate document that can be found on the website of the R package (<a href="http://vegmod.ctfc.cat/medfateweb" class="uri">http://vegmod.ctfc.cat/medfateweb</a>).</p>
</div>
<div id="preparing-model-inputs" class="section level2">
<h2 class="hasAnchor">
<a href="#preparing-model-inputs" class="anchor"></a>Preparing model inputs</h2>
<p>Most details of the soil plant water balance model inputs are already covered in vignette <strong>1. Introduction to water balance simulation</strong>. Here only differences are mentioned.</p>
<div id="soils" class="section level3">
<h3 class="hasAnchor">
<a href="#soils" class="anchor"></a>Soils</h3>
<p>The soil input for function is actually an object of class <code>soil</code> that is created using a function with the same name:</p>
<pre class="sourceCode r" id="cb1"><code class="sourceCode r"><div class="sourceLine" id="cb1-1" data-line-number="1">examplesoil =<span class="st"> </span><span class="kw"><a href="../reference/soil.html">soil</a></span>(<span class="kw"><a href="../reference/defaultSoilParams.html">defaultSoilParams</a></span>(<span class="dv">2</span>))</div></code></pre>
<p>Advanced soil plant energy and water balance modelling requires considering the temperature of soil. Hence, <code>Temp</code> contains the temperature (in degrees) of soil layers:</p>
<pre class="sourceCode r" id="cb2"><code class="sourceCode r"><div class="sourceLine" id="cb2-1" data-line-number="1">examplesoil<span class="op">$</span>Temp</div></code></pre>
<pre><code>## [1] NA NA</code></pre>
<p>Soil layer temperatures are initialized to missing values, so that at the first time step they will be set to atmospheric temperature. While simple water balance modeling can be run using either Saxton’s or Van Genuchten’s equations as water retention curves, Van Genuchten’s model is forced for advanced modelling.</p>
</div>
<div id="species-data-table" class="section level3">
<h3 class="hasAnchor">
<a href="#species-data-table" class="anchor"></a>Species data table</h3>
<p>Simulation models in <code>medfate</code> require a data frame with species parameter values. The package provides a default data set of parameter values for 89 Mediterranean species (rows), resulting from bibliographic search, fit to empirical data or expert-based guesses:</p>
<pre class="sourceCode r" id="cb4"><code class="sourceCode r"><div class="sourceLine" id="cb4-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(<span class="st">"SpParamsMED"</span>)</div></code></pre>
<p>These species commonly occur in the Spanish forest inventory of Catalonia, but may not be sufficient for other areas. A large number of parameters (columns) can be found in <code>SpParamsMED</code>:</p>
<pre class="sourceCode r" id="cb5"><code class="sourceCode r"><div class="sourceLine" id="cb5-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(SpParamsMED)</div></code></pre>
<pre><code>##  [1] "Name"               "IFNcodes"           "SpIndex"           
##  [4] "Group"              "Order"              "Family"            
##  [7] "GrowthForm"         "TreeType"           "Hmed"              
## [10] "Hmax"               "Z50"                "Z95"               
## [13] "Zmax"               "a_ash"              "a_bsh"             
## [16] "b_bsh"              "cr"                 "a_fbt"             
## [19] "b_fbt"              "c_fbt"              "d_fbt"             
## [22] "a_cr"               "b_1cr"              "b_2cr"             
## [25] "b_3cr"              "c_1cr"              "c_2cr"             
## [28] "a_cw"               "b_cw"               "fHDmin"            
## [31] "fHDmax"             "SLA"                "LeafDensity"       
## [34] "r635"               "pDead"              "maxFMC"            
## [37] "minFMC"             "LeafPI0"            "LeafEPS"           
## [40] "LeafAF"             "StemPI0"            "StemEPS"           
## [43] "StemAF"             "LeafDuration"       "LigninPercent"     
## [46] "ParticleDensity"    "LeafLitterFuelType" "Flammability"      
## [49] "SAV"                "HeatContent"        "albedo"            
## [52] "k"                  "g"                  "Sgdd"              
## [55] "Psi_Extract"        "WUE"                "pRootDisc"         
## [58] "Gwmin"              "Gwmax"              "VCleaf_kmax"       
## [61] "VCleaf_c"           "VCleaf_d"           "Kmax_stemxylem"    
## [64] "VCstem_c"           "VCstem_d"           "Kmax_rootxylem"    
## [67] "VCroot_c"           "VCroot_d"           "LeafWidth"         
## [70] "Narea"              "Vmax298"            "Jmax298"           
## [73] "Al2As"              "WoodDensity"        "WoodC"             
## [76] "RGRmax"             "Cstoragepmax"</code></pre>
<p>Not all parameters are needed for all models. The user can find parameter definitions in the help page of this data set. However, to fully understand the role of parameters in the model, the user should read the details of model design and formulation (<a href="http://vegmod.ctfc.cat/medfateweb" class="uri">http://vegmod.ctfc.cat/medfateweb</a>).</p>
</div>
<div id="vegetation" class="section level3">
<h3 class="hasAnchor">
<a href="#vegetation" class="anchor"></a>Vegetation</h3>
<p>Models included in <code>medfate</code> were primarily designed to be ran on <strong>forest inventory plots</strong> (these are explained in detail in <strong>1. Introduction to water balance simulation</strong>):</p>
<pre class="sourceCode r" id="cb7"><code class="sourceCode r"><div class="sourceLine" id="cb7-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(exampleforest)</div>
<div class="sourceLine" id="cb7-2" data-line-number="2">exampleforest</div></code></pre>
<pre><code>## $ID
## [1] "1"
## 
## $patchsize
## [1] 10000
## 
## $treeData
##   Species   N   DBH Height Z50  Z95
## 1      54 168 37.55    800 750 3000
## 2      68 384 14.60    660 750 3000
## 
## $shrubData
##   Species Cover Height Z50  Z95
## 1      65  3.75     30  50 1000
## 
## $herbCover
## [1] 10
## 
## $herbHeight
## [1] 20
## 
## $seedBank
##   Species Abundance
## 5      54       100
## 8      65       100
## 9      68       100
## 
## attr(,"class")
## [1] "forest" "list"</code></pre>
</div>
<div id="meteorological-forcing" class="section level3">
<h3 class="hasAnchor">
<a href="#meteorological-forcing" class="anchor"></a>Meteorological forcing</h3>
<p>Advanced water and energy balance modeling requires daily precipitation, radiation, wind speed, min/max temparatures and relative humitidy as inputs:</p>
<pre class="sourceCode r" id="cb9"><code class="sourceCode r"><div class="sourceLine" id="cb9-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(examplemeteo)</div>
<div class="sourceLine" id="cb9-2" data-line-number="2">
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(examplemeteo)</div></code></pre>
<pre><code>##            MeanTemperature MinTemperature MaxTemperature Precipitation
## 2001-01-01      3.57668969     -0.5934215       6.287950      4.869109
## 2001-01-02      1.83695972     -2.3662458       4.569737      2.498292
## 2001-01-03      0.09462563     -3.8541036       2.661951      0.000000
## 2001-01-04      1.13866156     -1.8744860       3.097705      5.796973
## 2001-01-05      4.70578690      0.3288287       7.551532      1.884401
## 2001-01-06      4.57036721      0.5461322       7.186784     13.359801
##            MeanRelativeHumidity MinRelativeHumidity MaxRelativeHumidity
## 2001-01-01             78.73709            65.15411           100.00000
## 2001-01-02             69.70800            57.43761            94.71780
## 2001-01-03             70.69610            58.77432            94.66823
## 2001-01-04             76.89156            66.84256            95.80950
## 2001-01-05             76.67424            62.97656           100.00000
## 2001-01-06             89.01940            74.25754           100.00000
##            Radiation WindSpeed WindDirection       PET
## 2001-01-01  12.89251  2.000000           172 1.3212770
## 2001-01-02  13.03079  7.662544           278 2.2185985
## 2001-01-03  16.90722  2.000000           141 1.8045176
## 2001-01-04  11.07275  2.000000           172 0.9200627
## 2001-01-05  13.45205  7.581347           321 2.2914449
## 2001-01-06  12.84841  6.570501           141 1.7255058</code></pre>
<p>Simulation models in <code>medfate</code> have been designed to work along with data generated from package <code>meteoland</code>. The user is strongly recommended to resort to this package to obtain suitable weather input for soil water balance simulations.</p>
</div>
<div id="simulation-control" class="section level3">
<h3 class="hasAnchor">
<a href="#simulation-control" class="anchor"></a>Simulation control</h3>
<p>Apart from data inputs, the behaviour of simulation models is controlled using a set of global parameters. The default parameterization is obtained using function <code><a href="../reference/defaultControl.html">defaultControl()</a></code>:</p>
<pre class="sourceCode r" id="cb11"><code class="sourceCode r"><div class="sourceLine" id="cb11-1" data-line-number="1">control =<span class="st"> </span><span class="kw"><a href="../reference/defaultControl.html">defaultControl</a></span>()</div></code></pre>
<p>To use the complex soil water balance model we must change the values of <code>transpirationMode</code> (to switch from “Granier” to “Sperry”) and <code>soilFunctions</code> (to switch from Saxton’s retention curve, “SX”, to Van Genuchten’s retention curve, “VG”):</p>
<pre class="sourceCode r" id="cb12"><code class="sourceCode r"><div class="sourceLine" id="cb12-1" data-line-number="1">control<span class="op">$</span>transpirationMode =<span class="st"> "Sperry"</span>
</div>
<div class="sourceLine" id="cb12-2" data-line-number="2">control<span class="op">$</span>soilFunctions =<span class="st"> "VG"</span>
</div></code></pre>
</div>
<div id="water-balance-input-object" class="section level3">
<h3 class="hasAnchor">
<a href="#water-balance-input-object" class="anchor"></a>Water balance input object</h3>
<p>A last step is needed before running the simulation function, consisting in the compilation of parameters and the calculation of additional parameter values for each plant cohort. If one has a <code>forest</code> object, the <code>spwbInput</code> object can be generated in directly from it:</p>
<pre class="sourceCode r" id="cb13"><code class="sourceCode r"><div class="sourceLine" id="cb13-1" data-line-number="1">x =<span class="st"> </span><span class="kw"><a href="../reference/forest2spwbInput.html">forest2spwbInput</a></span>(exampleforest, examplesoil, SpParamsMED, control)</div></code></pre>
<p>The <code>spwbInput</code> object for advanced water and energy balance is similar to that of simple water balance simulations, but contains more elements. Information about the cohort species is found in element <code>cohorts</code> (i.e. code, species and name):</p>
<pre class="sourceCode r" id="cb14"><code class="sourceCode r"><div class="sourceLine" id="cb14-1" data-line-number="1">x<span class="op">$</span>cohorts</div></code></pre>
<pre><code>##       SP              Name
## T1_54 54  Pinus halepensis
## T2_68 68      Quercus ilex
## S1_65 65 Quercus coccifera</code></pre>
<p>Element <code>canopy</code> contains state variables of the whole canopy, which include growth degree days and canopy temperature:</p>
<pre class="sourceCode r" id="cb16"><code class="sourceCode r"><div class="sourceLine" id="cb16-1" data-line-number="1">x<span class="op">$</span>canopy</div></code></pre>
<pre><code>## $gdd
## [1] 0
## 
## $Temp
## [1] NA</code></pre>
<p>Canopy temperature is a state variable (as soil temperature) needed for energy balance. As you may already known, element <code>above</code> contains the aboveground structure data that we already know:</p>
<pre class="sourceCode r" id="cb18"><code class="sourceCode r"><div class="sourceLine" id="cb18-1" data-line-number="1">x<span class="op">$</span>above</div></code></pre>
<pre><code>##         H        CR   LAI_live LAI_expanded LAI_dead
## T1_54 800 0.7150421 0.81670117   0.81670117        0
## T2_68 660 0.6055642 0.79779523   0.79779523        0
## S1_65  30 0.9738889 0.08913325   0.08913325        0</code></pre>
<p>Belowground parameters can be seen in <code>below</code>, which in the case of advance water and energy balance include root distribution as well as maximum root and rhizosphere conductances by soil layer:</p>
<pre class="sourceCode r" id="cb20"><code class="sourceCode r"><div class="sourceLine" id="cb20-1" data-line-number="1">x<span class="op">$</span>below</div></code></pre>
<pre><code>## $V
##               1         2
## T1_54 0.1933638 0.8066362
## T2_68 0.1933638 0.8066362
## S1_65 0.8981075 0.1018925
## 
## $VGrhizo_kmax
##                1        2
## T1_54    6902839 10429172
## T2_68   10201735 15656041
## S1_65 1147996981 49434689
## 
## $VCroot_kmax
##              1         2
## T1_54 1.009731 0.5494703
## T2_68 2.716662 1.4783401
## S1_65 3.110338 4.1089816</code></pre>
<p>The <code>spwbInput</code>object also includes cohort parameter values for several kinds of traits. For example, plant anatomy parameters are described in <code>paramsAnatomy</code>:</p>
<pre class="sourceCode r" id="cb22"><code class="sourceCode r"><div class="sourceLine" id="cb22-1" data-line-number="1">x<span class="op">$</span>paramsAnatomy</div></code></pre>
<pre><code>##          Al2As   SLA LeafWidth LeafDensity WoodDensity     r635
## T1_54 1317.523 4.340       0.1         0.7    0.552530 1.964226
## T2_68 2512.563 5.870       3.0         0.7    1.000000 1.805872
## S1_65 2512.563 5.859       1.0         0.7    0.651891 2.289452</code></pre>
<p>Parameters related to plant transpiration and photosynthesis can be seen in <code>paramsTransp</code>:</p>
<pre class="sourceCode r" id="cb24"><code class="sourceCode r"><div class="sourceLine" id="cb24-1" data-line-number="1">x<span class="op">$</span>paramsTransp</div></code></pre>
<pre><code>##         Gwmin     Gwmax Vmax298  Jmax298 Kmax_stemxylem Kmax_rootxylem
## T1_54 0.00203 0.1900000    62.5 129.5000      0.1500000       0.893000
## T2_68 0.00450 0.1727514    66.2 130.0000      0.7735834       3.094334
## S1_65 0.01045 0.4518345   100.0 163.6253      0.2900000       1.160000
##       VCleaf_kmax VCleaf_c  VCleaf_d VCstem_kmax VCstem_c  VCstem_d
## T1_54           6 2.204804 -2.448294    1.257285 2.204804 -3.672441
## T2_68           8 2.188265 -4.138168    4.299811 1.158507 -4.390826
## S1_65           8 2.931921 -5.257850   12.080826 2.931921 -7.886774
##       VCroot_kmax VCroot_c  VCroot_d pRootDisc Plant_kmax
## T1_54    1.559201 1.056898 -1.244767         0  0.6236803
## T2_68    4.195002 1.494098 -2.134283         0  1.6780008
## S1_65    7.219320 2.498414 -5.413810         0  2.8877280</code></pre>
<p>Finally, parameters related to pressure-volume curves and water storage capacity of leaf and stem organs are in <code>paramsWaterStorage</code>:</p>
<pre class="sourceCode r" id="cb26"><code class="sourceCode r"><div class="sourceLine" id="cb26-1" data-line-number="1">x<span class="op">$</span>paramsWaterStorage</div></code></pre>
<pre><code>##       LeafPI0 LeafEPS LeafAF        Vleaf   StemPI0  StemEPS StemAF
## T1_54   -2.11   12.18  0.162 0.0001795440 -1.778525 10.43383    0.8
## T2_68   -2.39   19.26  0.170 0.0001327463 -3.640000 70.78258    0.8
## S1_65   -2.37   17.23  0.240 0.0001329955 -2.191867 16.03623    0.8
##           Vsapwood
## T1_54 0.0018688575
## T2_68 0.0004421211
## S1_65 0.0000330515</code></pre>
<p>Finally, remember that one can play with plant-specific parameters for soil water balance (instead of using species-level values) by modifying manually the parameter values in this object.</p>
</div>
</div>
<div id="static-analysis-of-submodels" class="section level2">
<h2 class="hasAnchor">
<a href="#static-analysis-of-submodels" class="anchor"></a>Static analysis of submodels</h2>
<p>Before using the advanced water and energy balance model, is important to understand the parameters that influence the different sub-models. Package <code>medfate</code> provides low-level functions corresponding to sub-models (light extinction, hydraulics, transpiration, photosynthesis…). In addition, there are several high-level plotting functions that allow examining several aspects of these processes.</p>
<div id="vulnerability-curves" class="section level3">
<h3 class="hasAnchor">
<a href="#vulnerability-curves" class="anchor"></a>Vulnerability curves</h3>
<p>Given a <code>spwbInput</code> object, we can use function <code><a href="../reference/hydraulics_conductancefunctions.html">hydraulics_vulnerabilityCurvePlot()</a></code> to inspect <strong>vulnerability curves</strong> (i.e. how hydraulic conductance of a given segment changes with the water potential) for each plant cohort and each of the different segments of the soil-plant hydraulic network: rhizosphere, roots, stems and leaves:</p>
<pre class="sourceCode r" id="cb28"><code class="sourceCode r"><div class="sourceLine" id="cb28-1" data-line-number="1">
<span class="kw"><a href="../reference/hydraulics_conductancefunctions.html">hydraulics_vulnerabilityCurvePlot</a></span>(x, <span class="dt">type=</span><span class="st">"leaf"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-17-1.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb29"><code class="sourceCode r"><div class="sourceLine" id="cb29-1" data-line-number="1">
<span class="kw"><a href="../reference/hydraulics_conductancefunctions.html">hydraulics_vulnerabilityCurvePlot</a></span>(x, <span class="dt">type=</span><span class="st">"stem"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-17-2.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb30"><code class="sourceCode r"><div class="sourceLine" id="cb30-1" data-line-number="1">
<span class="kw"><a href="../reference/hydraulics_conductancefunctions.html">hydraulics_vulnerabilityCurvePlot</a></span>(x, <span class="dt">type=</span><span class="st">"root"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-17-3.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb31"><code class="sourceCode r"><div class="sourceLine" id="cb31-1" data-line-number="1">
<span class="kw"><a href="../reference/hydraulics_conductancefunctions.html">hydraulics_vulnerabilityCurvePlot</a></span>(x, examplesoil, <span class="dt">type=</span><span class="st">"rhizo"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-17-4.png" width="480" style="display: block; margin: auto;"></p>
<p>The maximum values and shape of vulnerability curves for leaves and stems are regulated by parameters in <code>paramsTransp</code>. Roots have vulnerability curve parameters in the same data frame, but maximum conductance values need to be specified for each soil layer and are given in <code>below$VCroot_kmax</code>. Note that the last call to <code><a href="../reference/hydraulics_conductancefunctions.html">hydraulics_vulnerabilityCurvePlot()</a></code> includes a <code>soil</code> object. This is because the van Genuchten parameters that define the shape of the vulnerability curve for the rhizosphere are stored in this object. Maximum conductance values in the rhizosphere are given in <code>below$VGrhizo_kmax</code>.</p>
</div>
<div id="supply-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#supply-functions" class="anchor"></a>Supply functions</h3>
<p>The vulnerability curves conformng the hydraulic network are used in the model to build the <strong>supply function</strong>, which relates water flow (i.e. transpiration) with the drop of water potential along the whole hydraulic pathway. The supply function contains not only these two variables, but also the water potential of intermediate nodes in the the hydraulic network. Function <code><a href="../reference/hydraulics_supplyfunctions.html">hydraulics_supplyFunctionPlot()</a></code> can be used to inspect any of this variables:</p>
<pre class="sourceCode r" id="cb32"><code class="sourceCode r"><div class="sourceLine" id="cb32-1" data-line-number="1">
<span class="kw"><a href="../reference/hydraulics_supplyfunctions.html">hydraulics_supplyFunctionPlot</a></span>(x, examplesoil, <span class="dt">type=</span><span class="st">"E"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-18-1.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb33"><code class="sourceCode r"><div class="sourceLine" id="cb33-1" data-line-number="1">
<span class="kw"><a href="../reference/hydraulics_supplyfunctions.html">hydraulics_supplyFunctionPlot</a></span>(x, examplesoil, <span class="dt">type=</span><span class="st">"ERhizo"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-18-2.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb34"><code class="sourceCode r"><div class="sourceLine" id="cb34-1" data-line-number="1">
<span class="kw"><a href="../reference/hydraulics_supplyfunctions.html">hydraulics_supplyFunctionPlot</a></span>(x, examplesoil, <span class="dt">type=</span><span class="st">"dEdP"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-18-3.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb35"><code class="sourceCode r"><div class="sourceLine" id="cb35-1" data-line-number="1">
<span class="kw"><a href="../reference/hydraulics_supplyfunctions.html">hydraulics_supplyFunctionPlot</a></span>(x, examplesoil, <span class="dt">type=</span><span class="st">"psiStem"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-18-4.png" width="480" style="display: block; margin: auto;"></p>
<p>Calls to <code><a href="../reference/hydraulics_supplyfunctions.html">hydraulics_supplyFunctionPlot()</a></code> always need both a <code>spwbInput</code> object and a <code>soil</code> object. The soil moisture state (i.e. its water potential) is the starting point for the calculation of the supply function, so different curves will be obtained for different values of soil moisture.</p>
</div>
<div id="stomatal-regulation-and-photosynthesis" class="section level3">
<h3 class="hasAnchor">
<a href="#stomatal-regulation-and-photosynthesis" class="anchor"></a>Stomatal regulation and photosynthesis</h3>
<p>The soil water balance model determines stomatal conductance and transpiration separately for sunlit and shade leaves. Stomatal conductance is determined after building a photosynthesis function corresponding to the supply function and finding the value of stomatal conductance that maximizes carbon revenue while avoiding hydraulic damage (a profit-maximization approach). Given a meteorological and soil inputs and a chosen day and timestep, function <code><a href="../reference/transpiration.html">transp_stomatalRegulationPlot()</a></code> allows displaying the supply and photosynthesis curves for sunlit and shade leaves, along with an indication of the values corresponding to the chosen stomatal aperture:</p>
<pre class="sourceCode r" id="cb36"><code class="sourceCode r"><div class="sourceLine" id="cb36-1" data-line-number="1">d =<span class="st"> </span><span class="dv">100</span>
</div>
<div class="sourceLine" id="cb36-2" data-line-number="2">
<span class="kw"><a href="../reference/transpiration.html">transp_stomatalRegulationPlot</a></span>(x, examplesoil, examplemeteo, <span class="dt">day =</span> d, <span class="dt">timestep=</span><span class="dv">12</span>,</div>
<div class="sourceLine" id="cb36-3" data-line-number="3">                              <span class="dt">latitude =</span> <span class="fl">41.82592</span>, <span class="dt">elevation =</span> <span class="dv">100</span>, <span class="dt">type=</span><span class="st">"E"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-19-1.png" width="672" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb37"><code class="sourceCode r"><div class="sourceLine" id="cb37-1" data-line-number="1">
<span class="kw"><a href="../reference/transpiration.html">transp_stomatalRegulationPlot</a></span>(x, examplesoil, examplemeteo, <span class="dt">day =</span> d, <span class="dt">timestep=</span><span class="dv">12</span>,</div>
<div class="sourceLine" id="cb37-2" data-line-number="2">                              <span class="dt">latitude =</span> <span class="fl">41.82592</span>, <span class="dt">elevation =</span> <span class="dv">100</span>, <span class="dt">type=</span><span class="st">"An"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-19-2.png" width="672" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb38"><code class="sourceCode r"><div class="sourceLine" id="cb38-1" data-line-number="1">
<span class="kw"><a href="../reference/transpiration.html">transp_stomatalRegulationPlot</a></span>(x, examplesoil, examplemeteo, <span class="dt">day =</span> d, <span class="dt">timestep=</span><span class="dv">12</span>,</div>
<div class="sourceLine" id="cb38-2" data-line-number="2">                              <span class="dt">latitude =</span> <span class="fl">41.82592</span>, <span class="dt">elevation =</span> <span class="dv">100</span>, <span class="dt">type=</span><span class="st">"Gw"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-19-3.png" width="672" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb39"><code class="sourceCode r"><div class="sourceLine" id="cb39-1" data-line-number="1">
<span class="kw"><a href="../reference/transpiration.html">transp_stomatalRegulationPlot</a></span>(x, examplesoil, examplemeteo, <span class="dt">day =</span> d, <span class="dt">timestep=</span><span class="dv">12</span>,</div>
<div class="sourceLine" id="cb39-2" data-line-number="2">                              <span class="dt">latitude =</span> <span class="fl">41.82592</span>, <span class="dt">elevation =</span> <span class="dv">100</span>, <span class="dt">type=</span><span class="st">"T"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-19-4.png" width="672" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb40"><code class="sourceCode r"><div class="sourceLine" id="cb40-1" data-line-number="1">
<span class="kw"><a href="../reference/transpiration.html">transp_stomatalRegulationPlot</a></span>(x, examplesoil, examplemeteo, <span class="dt">day =</span> d, <span class="dt">timestep=</span><span class="dv">12</span>,</div>
<div class="sourceLine" id="cb40-2" data-line-number="2">                              <span class="dt">latitude =</span> <span class="fl">41.82592</span>, <span class="dt">elevation =</span> <span class="dv">100</span>, <span class="dt">type=</span><span class="st">"VPD"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-19-5.png" width="672" style="display: block; margin: auto;"></p>
</div>
<div id="pressure-volume-curves" class="section level3">
<h3 class="hasAnchor">
<a href="#pressure-volume-curves" class="anchor"></a>Pressure volume curves</h3>
<pre class="sourceCode r" id="cb41"><code class="sourceCode r"><div class="sourceLine" id="cb41-1" data-line-number="1">
<span class="kw"><a href="../reference/moisture.html">moisture_pressureVolumeCurvePlot</a></span>(x, <span class="dt">segment=</span><span class="st">"leaf"</span>, <span class="dt">fraction=</span><span class="st">"symplastic"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-20-1.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb42"><code class="sourceCode r"><div class="sourceLine" id="cb42-1" data-line-number="1">
<span class="kw"><a href="../reference/moisture.html">moisture_pressureVolumeCurvePlot</a></span>(x, <span class="dt">segment=</span><span class="st">"leaf"</span>, <span class="dt">fraction=</span><span class="st">"apoplastic"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-20-2.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb43"><code class="sourceCode r"><div class="sourceLine" id="cb43-1" data-line-number="1">
<span class="kw"><a href="../reference/moisture.html">moisture_pressureVolumeCurvePlot</a></span>(x, <span class="dt">segment=</span><span class="st">"stem"</span>, <span class="dt">fraction=</span><span class="st">"symplastic"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-20-3.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb44"><code class="sourceCode r"><div class="sourceLine" id="cb44-1" data-line-number="1">
<span class="kw"><a href="../reference/moisture.html">moisture_pressureVolumeCurvePlot</a></span>(x, <span class="dt">segment=</span><span class="st">"stem"</span>, <span class="dt">fraction=</span><span class="st">"apoplastic"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-20-4.png" width="480" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="water-balance-for-a-single-day" class="section level2">
<h2 class="hasAnchor">
<a href="#water-balance-for-a-single-day" class="anchor"></a>Water balance for a single day</h2>
<div id="running-the-model" class="section level3">
<h3 class="hasAnchor">
<a href="#running-the-model" class="anchor"></a>Running the model</h3>
<p>Soil water balance simulations will normally span periods of several months or years, but since the model operates at a daily and subdaily temporal scales, it is possible to perform soil water balance for one day only. This is done using function <code><a href="../reference/spwb_day.html">spwb_day()</a></code>. In the following code we select the same day as before from the meteorological input data and perform soil water balance for that day only:</p>
<pre class="sourceCode r" id="cb45"><code class="sourceCode r"><div class="sourceLine" id="cb45-1" data-line-number="1">sd1&lt;-<span class="kw"><a href="../reference/spwb_day.html">spwb_day</a></span>(x, examplesoil, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">rownames</a></span>(examplemeteo)[d],  </div>
<div class="sourceLine" id="cb45-2" data-line-number="2">             examplemeteo<span class="op">$</span>MinTemperature[d], examplemeteo<span class="op">$</span>MaxTemperature[d], </div>
<div class="sourceLine" id="cb45-3" data-line-number="3">             examplemeteo<span class="op">$</span>MinRelativeHumidity[d], examplemeteo<span class="op">$</span>MaxRelativeHumidity[d], </div>
<div class="sourceLine" id="cb45-4" data-line-number="4">             examplemeteo<span class="op">$</span>Radiation[d], examplemeteo<span class="op">$</span>WindSpeed[d], </div>
<div class="sourceLine" id="cb45-5" data-line-number="5">             <span class="dt">latitude =</span> <span class="fl">41.82592</span>, <span class="dt">elevation =</span> <span class="dv">100</span>, </div>
<div class="sourceLine" id="cb45-6" data-line-number="6">             <span class="dt">slope=</span> <span class="dv">0</span>, <span class="dt">aspect =</span> <span class="dv">0</span>, <span class="dt">prec =</span> examplemeteo<span class="op">$</span>Precipitation[d])</div></code></pre>
<p>The output of <code><a href="../reference/spwb_day.html">spwb_day()</a></code> is a list with several elements:</p>
<pre class="sourceCode r" id="cb46"><code class="sourceCode r"><div class="sourceLine" id="cb46-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(sd1)</div></code></pre>
<pre><code>##  [1] "cohorts"         "WaterBalance"    "EnergyBalance"  
##  [4] "Soil"            "Stand"           "Plants"         
##  [7] "RhizoPsi"        "SunlitLeaves"    "ShadeLeaves"    
## [10] "ExtractionInst"  "PlantsInst"      "LightExtinction"
## [13] "WindExtinction"</code></pre>
</div>
<div id="water-balance-output" class="section level3">
<h3 class="hasAnchor">
<a href="#water-balance-output" class="anchor"></a>Water balance output</h3>
<p>Element <code>WaterBalance</code> contains the soil water balance flows of the day (precipitation, infiltration, transpiration, …)</p>
<pre class="sourceCode r" id="cb48"><code class="sourceCode r"><div class="sourceLine" id="cb48-1" data-line-number="1">sd1<span class="op">$</span>WaterBalance</div></code></pre>
<pre><code>##                     PET                    Rain                    Snow 
##               5.0233468               0.0000000               0.0000000 
##                 NetRain                Snowmelt                   Runon 
##               0.0000000               0.0000000               0.0000000 
##            Infiltration                  Runoff            DeepDrainage 
##               0.0000000               0.0000000               0.0000000 
##         SoilEvaporation         PlantExtraction           Transpiration 
##               0.5000000               0.8609921               0.8609921 
## HydraulicRedistribution 
##               0.0000000</code></pre>
<p>And <code>Soil</code> contains water evaporated from each soil layer, water transpired from each soil layer and the final soil water potential:</p>
<pre class="sourceCode r" id="cb50"><code class="sourceCode r"><div class="sourceLine" id="cb50-1" data-line-number="1">sd1<span class="op">$</span>Soil</div></code></pre>
<pre><code>##   SoilEvaporation HydraulicInput HydraulicOutput PlantExtraction
## 1    4.999998e-01              0       0.5273331       0.5273331
## 2    1.529512e-07              0       0.3336590       0.3336590
##           psi
## 1 -0.03555815
## 2 -0.03341246</code></pre>
</div>
<div id="soil-and-canopy-energy-balance" class="section level3">
<h3 class="hasAnchor">
<a href="#soil-and-canopy-energy-balance" class="anchor"></a>Soil and canopy energy balance</h3>
<p>Element <code>EnergyBalance</code> contains subdaily variation in atmosphere, canopy and soil temperatures, as well as canopy and soil energy balance components.</p>
<pre class="sourceCode r" id="cb52"><code class="sourceCode r"><div class="sourceLine" id="cb52-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(sd1<span class="op">$</span>EnergyBalance)</div></code></pre>
<pre><code>## [1] "Temperature"         "CanopyEnergyBalance" "SoilEnergyBalance"</code></pre>
<p>Package <code>medfate</code> provides a <code>plot</code> function for objects of class <code>spwb_day</code> that can be used to inspect the results of the simulation. We use this function to display subdaily dynamics in plant, soil and canopy variables. For example, we can use it to display temperature variations (only the temperature of the topmost soil layer is drawn):</p>
<pre class="sourceCode r" id="cb54"><code class="sourceCode r"><div class="sourceLine" id="cb54-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"Temperature"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-26-1.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb55"><code class="sourceCode r"><div class="sourceLine" id="cb55-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"CanopyEnergyBalance"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-26-2.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb56"><code class="sourceCode r"><div class="sourceLine" id="cb56-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"SoilEnergyBalance"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-26-3.png" width="480" style="display: block; margin: auto;"></p>
</div>
<div id="plant-output" class="section level3">
<h3 class="hasAnchor">
<a href="#plant-output" class="anchor"></a>Plant output</h3>
<p>Element <code>Plants</code> contains output values by plant cohort. Several output variables can be inspected in this element.</p>
<pre class="sourceCode r" id="cb57"><code class="sourceCode r"><div class="sourceLine" id="cb57-1" data-line-number="1">sd1<span class="op">$</span>Plants</div></code></pre>
<pre><code>##              LAI Extraction Transpiration Photosynthesis    RootPsi
## T1_54 0.81670117  0.2147913     0.2147913      1.6068891 -0.3370575
## T2_68 0.79779523  0.5175457     0.5175457      1.8928595 -0.3151166
## S1_65 0.08913325  0.1286551     0.1286551      0.1885441 -0.3869046
##          StemPsi      StemPLC LeafPsiMin  LeafPsiMax LeafPsiMin_SL
## T1_54 -0.6707915 1.582380e-03 -0.7444369 -0.08393788    -0.9489844
## T2_68 -0.6028783 1.830652e-02 -0.7493966 -0.06369044    -1.2662108
## S1_65 -0.5980477 3.521207e-05 -0.9179349 -0.05084006    -1.3203596
##       LeafPsiMax_SL LeafPsiMin_SH LeafPsiMax_SH      dEdP         DDS
## T1_54   -0.08393788    -0.6424626   -0.08393788 0.5888088 0.055912530
## T2_68   -0.06369044    -0.4297945   -0.06369044 1.6252892 0.031413267
## S1_65   -0.05084006    -0.7787794   -0.05084006 2.8837937 0.001362416
##         StemRWC   LeafRWC
## T1_54 0.9940219 0.9780150
## T2_68 0.9847179 0.9878989
## S1_65 0.9973600 0.9859628</code></pre>
<p>While <code>Plants</code> contains one value per cohort and variable that summarizes the whole simulated day, information by disaggregated by time step can be accessed in <code>PlantsInst</code>. Moreover, we can use function <code><a href="../reference/plot.spwb_day.html">plot.spwb_day()</a></code> to draw plots of sub-daily variation per species of plant transpiration per ground area (L·m<span class="math inline">\(^{-2}\)</span>), transpiration per leaf area (also in L·m<span class="math inline">\(^{-2}\)</span>), plant net photosynthesis (in g C·m<span class="math inline">\(^{-2}\)</span>), and plant water potential (in MPa):</p>
<pre class="sourceCode r" id="cb59"><code class="sourceCode r"><div class="sourceLine" id="cb59-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"PlantTranspiration"</span>, <span class="dt">bySpecies =</span> T)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-28-1.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb60"><code class="sourceCode r"><div class="sourceLine" id="cb60-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"PlantTranspirationPerLeaf"</span>, <span class="dt">bySpecies =</span> T)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-28-2.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb61"><code class="sourceCode r"><div class="sourceLine" id="cb61-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"PlantPhotosynthesis"</span>, <span class="dt">bySpecies =</span> T)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-28-3.png" width="480" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb62"><code class="sourceCode r"><div class="sourceLine" id="cb62-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"LeafPsiAverage"</span>, <span class="dt">bySpecies =</span> T)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-28-4.png" width="480" style="display: block; margin: auto;"></p>
</div>
<div id="output-for-sunlit-and-shade-leaves" class="section level3">
<h3 class="hasAnchor">
<a href="#output-for-sunlit-and-shade-leaves" class="anchor"></a>Output for sunlit and shade leaves</h3>
<p>The model distinguishes between sunlit and shade leaves for stomatal regulation. Static properties of sunlit and shade leaves, for each cohort, can be accessed via:</p>
<pre class="sourceCode r" id="cb63"><code class="sourceCode r"><div class="sourceLine" id="cb63-1" data-line-number="1">sd1<span class="op">$</span>SunlitLeaves</div></code></pre>
<pre><code>##              LAI  Vmax298   Jmax298
## T1_54 0.39267054 48.58012 100.65801
## T2_68 0.30498777 50.32556  98.82662
## S1_65 0.02201173 70.01225 114.55776</code></pre>
<pre class="sourceCode r" id="cb65"><code class="sourceCode r"><div class="sourceLine" id="cb65-1" data-line-number="1">sd1<span class="op">$</span>ShadeLeaves</div></code></pre>
<pre><code>##              LAI  Vmax298   Jmax298
## T1_54 0.42403063 41.02069  84.99488
## T2_68 0.49280746 45.36770  89.09065
## S1_65 0.06712152 70.01225 114.55776</code></pre>
<p>Instantaneous values are also stored for sunlit and shade leaves. We can also use the <code>plot</code> function for objects of class <code>spwb_day</code> to draw instantaneous variations in temperature for sunlit and shade leaves:</p>
<pre class="sourceCode r" id="cb67"><code class="sourceCode r"><div class="sourceLine" id="cb67-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"LeafTemperature"</span>, <span class="dt">bySpecies=</span><span class="ot">TRUE</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-30-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Note that sunlit leaves of some species reach temperatures higher than the canopy. We can also plot variations in instantaneous net photosynthesis rates:</p>
<pre class="sourceCode r" id="cb68"><code class="sourceCode r"><div class="sourceLine" id="cb68-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"LeafPhotosynthesis"</span>, <span class="dt">bySpecies=</span><span class="ot">TRUE</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-31-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Or variations in stomatal conductance:</p>
<pre class="sourceCode r" id="cb69"><code class="sourceCode r"><div class="sourceLine" id="cb69-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"LeafStomatalConductance"</span>, <span class="dt">bySpecies=</span><span class="ot">TRUE</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-32-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Or variations in vapour pressure deficit:</p>
<pre class="sourceCode r" id="cb70"><code class="sourceCode r"><div class="sourceLine" id="cb70-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"LeafVPD"</span>, <span class="dt">bySpecies=</span><span class="ot">TRUE</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-33-1.png" width="672" style="display: block; margin: auto;"></p>
<p>Or variations in leaf water potential:</p>
<pre class="sourceCode r" id="cb71"><code class="sourceCode r"><div class="sourceLine" id="cb71-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"LeafPsi"</span>, <span class="dt">bySpecies=</span><span class="ot">TRUE</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-34-1.png" width="672" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb72"><code class="sourceCode r"><div class="sourceLine" id="cb72-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"LeafCi"</span>, <span class="dt">bySpecies=</span><span class="ot">TRUE</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-35-1.png" width="720" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb73"><code class="sourceCode r"><div class="sourceLine" id="cb73-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(sd1, <span class="dt">type =</span> <span class="st">"LeafIntrinsicWUE"</span>, <span class="dt">bySpecies=</span><span class="ot">TRUE</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-36-1.png" width="720" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="water-balance-for-multiple-days" class="section level2">
<h2 class="hasAnchor">
<a href="#water-balance-for-multiple-days" class="anchor"></a>Water balance for multiple days</h2>
<div id="running-the-model-1" class="section level3">
<h3 class="hasAnchor">
<a href="#running-the-model-1" class="anchor"></a>Running the model</h3>
<p>Users will often use function <code><a href="../reference/spwb.html">spwb()</a></code> to run the soil water balance model for several days. This function requires the <code>spwbInput</code> object, the <code>soil</code> object and the meteorological data frame. However, running <code><a href="../reference/spwb_day.html">spwb_day()</a></code> modified the input objects. In particular, the soil moisture at the end of the simulation was:</p>
<pre class="sourceCode r" id="cb74"><code class="sourceCode r"><div class="sourceLine" id="cb74-1" data-line-number="1">examplesoil<span class="op">$</span>W</div></code></pre>
<pre><code>## [1] 0.9849889 0.9973781</code></pre>
<p>And the temperature of soil layers:</p>
<pre class="sourceCode r" id="cb76"><code class="sourceCode r"><div class="sourceLine" id="cb76-1" data-line-number="1">examplesoil<span class="op">$</span>Temp</div></code></pre>
<pre><code>## [1] 9.894257 8.091522</code></pre>
<p>We can also see the current state of canopy variables:</p>
<pre class="sourceCode r" id="cb78"><code class="sourceCode r"><div class="sourceLine" id="cb78-1" data-line-number="1">x<span class="op">$</span>canopy</div></code></pre>
<pre><code>## $gdd
## [1] 1.232373
## 
## $Temp
## [1] 6.235563</code></pre>
<p>We simply use function <code><a href="../reference/spwb.html">spwb_resetInputs()</a></code> to reset state variables to their default values, so that the new simulation is not affected by the end state of the previous simulation:</p>
<pre class="sourceCode r" id="cb80"><code class="sourceCode r"><div class="sourceLine" id="cb80-1" data-line-number="1">
<span class="kw"><a href="../reference/spwb.html">spwb_resetInputs</a></span>(x, examplesoil)</div>
<div class="sourceLine" id="cb80-2" data-line-number="2">examplesoil<span class="op">$</span>W</div></code></pre>
<pre><code>## [1] 1 1</code></pre>
<pre class="sourceCode r" id="cb82"><code class="sourceCode r"><div class="sourceLine" id="cb82-1" data-line-number="1">examplesoil<span class="op">$</span>Temp</div></code></pre>
<pre><code>## [1] NA NA</code></pre>
<pre class="sourceCode r" id="cb84"><code class="sourceCode r"><div class="sourceLine" id="cb84-1" data-line-number="1">x<span class="op">$</span>canopy</div></code></pre>
<pre><code>## $gdd
## [1] 0
## 
## $Temp
## [1] NA</code></pre>
<p>Now we are ready to call function <code><a href="../reference/spwb.html">spwb()</a></code>. In this example, we only simulate 61 days to save computational time:</p>
<pre class="sourceCode r" id="cb86"><code class="sourceCode r"><div class="sourceLine" id="cb86-1" data-line-number="1">S =<span class="st"> </span><span class="kw"><a href="../reference/spwb.html">spwb</a></span>(x, examplesoil, examplemeteo[<span class="dv">110</span><span class="op">:</span><span class="dv">170</span>,], <span class="dt">latitude =</span> <span class="fl">41.82592</span>, <span class="dt">elevation =</span> <span class="dv">100</span>)</div></code></pre>
<pre><code>## Initial soil water content (mm): 195.696
## Performing daily simulations .......done.
## Final soil water content (mm): 145.223
## Change in soil water content (mm): -50.4731
## Water balance result (mm): -50.4731
## Water balance components:
##   Precipitation (mm) 36
##   Rain (mm) 26 Snow (mm) 10
##   Interception (mm) 6 Net rainfall (mm) 20
##   Infiltration (mm) 30 Runoff (mm) 0 Deep drainage (mm) 18
##   Soil evaporation (mm) 3 Transpiration (mm) 58
##   Plant extraction from soil (mm) 58 Hydraulic redistribution (mm) 2</code></pre>
<p>Function <code><a href="../reference/spwb.html">spwb()</a></code> returns an object of class <em>spwb</em>. If we inspect its elements, we realize that the output is arranged differently than in <code><a href="../reference/spwb_day.html">spwb_day()</a></code>:</p>
<pre class="sourceCode r" id="cb88"><code class="sourceCode r"><div class="sourceLine" id="cb88-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(S)</div></code></pre>
<pre><code>##  [1] "latitude"            "topography"          "spwbInput"          
##  [4] "soilInput"           "WaterBalance"        "Soil"               
##  [7] "Stand"               "EnergyBalance"       "Temperature"        
## [10] "PlantLAI"            "PlantAbsorbedSWR"    "PlantAbsorbedLWR"   
## [13] "PlantTranspiration"  "PlantPhotosynthesis" "dEdP"               
## [16] "LeafPsiMin"          "LeafPsiMax"          "LeafPsiMin_SL"      
## [19] "LeafPsiMax_SL"       "LeafPsiMin_SH"       "LeafPsiMax_SH"      
## [22] "LeafRWC"             "StemPsi"             "StemPLC"            
## [25] "StemRWC"             "RootPsi"             "RhizoPsi"           
## [28] "PlantStress"         "subdaily"</code></pre>
<p>In particular, element <code>spwbInput</code> contains a copy of the input parameters that were used to run the model:</p>
<pre class="sourceCode r" id="cb90"><code class="sourceCode r"><div class="sourceLine" id="cb90-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(S<span class="op">$</span>spwbInput)</div></code></pre>
<pre><code>##  [1] "control"            "canopy"             "cohorts"           
##  [4] "above"              "below"              "paramsBase"        
##  [7] "paramsAnatomy"      "paramsTransp"       "paramsWaterStorage"
## [10] "Transpiration"      "Photosynthesis"     "PLCstem"           
## [13] "RWCsympstem"        "RWCsympleaf"        "Einst"             
## [16] "psiRhizo"           "psiRoot"            "psiStem"           
## [19] "psiLeaf"</code></pre>
<p>As before, <code>WaterBalance</code> contains water balance components, but in this case in form of a data frame with days in rows:</p>
<pre class="sourceCode r" id="cb92"><code class="sourceCode r"><div class="sourceLine" id="cb92-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(S<span class="op">$</span>WaterBalance)</div></code></pre>
<pre><code>##                 PET Precipitation      Rain     Snow    NetRain  Snowmelt
## 2001-04-20 2.641801     2.1625135 0.0000000 2.162513 0.00000000 0.0000000
## 2001-04-21 1.875251     3.7992356 0.0000000 3.799236 0.00000000 0.0000000
## 2001-04-22 2.903129     4.1962782 0.0000000 4.196278 0.00000000 0.9135326
## 2001-04-23 3.633982     1.4698434 1.4698434 0.000000 0.59989217 9.2444948
## 2001-04-24 3.891957     0.1538991 0.1538991 0.000000 0.06281136 0.0000000
## 2001-04-25 4.171116     0.1317847 0.1317847 0.000000 0.05378573 0.0000000
##            Infiltration Runoff DeepDrainage Evapotranspiration
## 2001-04-20   0.00000000      0      0.00000          0.4518367
## 2001-04-21   0.00000000      0      0.00000          0.4634813
## 2001-04-22   0.91353255      0      0.00000          0.5878512
## 2001-04-23   9.84438693      0      9.25475          2.0049774
## 2001-04-24   0.06281136      0      0.00000          0.9816666
## 2001-04-25   0.05378573      0      0.00000          1.0971030
##            Interception SoilEvaporation PlantExtraction Transpiration
## 2001-04-20   0.00000000      0.00000000       0.4518367     0.4518367
## 2001-04-21   0.00000000      0.00000000       0.4634813     0.4634813
## 2001-04-22   0.00000000      0.00000000       0.5878512     0.5878512
## 2001-04-23   0.86995127      0.50000000       0.6350261     0.6350261
## 2001-04-24   0.09108774      0.13686755       0.7537113     0.7537113
## 2001-04-25   0.07799896      0.08639181       0.9327123     0.9327123
##            HydraulicRedistribution
## 2001-04-20                       0
## 2001-04-21                       0
## 2001-04-22                       0
## 2001-04-23                       0
## 2001-04-24                       0
## 2001-04-25                       0</code></pre>
<p>Elements <code>PlantLAI</code>, <code>PlantStress</code>, <code>LeafPsi</code>, <code>PlantTranspiration</code> and <code>PlantPhotosynthesis</code> contain daily values by plant cohorts, for example plant water potentials are:</p>
<pre class="sourceCode r" id="cb94"><code class="sourceCode r"><div class="sourceLine" id="cb94-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(S<span class="op">$</span>LeafPsi)</div></code></pre>
<pre><code>## NULL</code></pre>
</div>
<div id="plotting-and-summarizing-results" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-and-summarizing-results" class="anchor"></a>Plotting and summarizing results</h3>
<p>Package <code>medfate</code> also provides a <code>plot</code> function for objects of class <code>spwb</code>. It can be used to show the meteorological input. Additionally, it can also be used to draw soil and plant variables. In the code below we draw water fluxes, soil water potentials, plant transpiration and plant (mid-day) water potential:</p>
<pre class="sourceCode r" id="cb96"><code class="sourceCode r"><div class="sourceLine" id="cb96-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(S, <span class="dt">type=</span><span class="st">"Evapotranspiration"</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-46-1.png" width="672" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb97"><code class="sourceCode r"><div class="sourceLine" id="cb97-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(S, <span class="dt">type=</span><span class="st">"SoilPsi"</span>, <span class="dt">bySpecies =</span> <span class="ot">TRUE</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-46-2.png" width="672" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb98"><code class="sourceCode r"><div class="sourceLine" id="cb98-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(S, <span class="dt">type=</span><span class="st">"PlantTranspiration"</span>, <span class="dt">bySpecies =</span> <span class="ot">TRUE</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-46-3.png" width="672" style="display: block; margin: auto;"></p>
<pre class="sourceCode r" id="cb99"><code class="sourceCode r"><div class="sourceLine" id="cb99-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(S, <span class="dt">type=</span><span class="st">"LeafPsiMin"</span>, <span class="dt">bySpecies =</span> <span class="ot">TRUE</span>)</div></code></pre>
<p><img src="2_AdvancedWaterEnergyBalance_files/figure-html/unnamed-chunk-46-4.png" width="672" style="display: block; margin: auto;"></p>
<p>While the simulation model uses daily steps, users may be interested in outputs at larger time scales. The package provides a <code>summary</code> for objects of class <code>spwb</code>. This function can be used to summarize the model’s output at different temporal steps (i.e. weekly, annual, …). For example, to obtain the average soil moisture and water potentials by months one can use:</p>
<pre class="sourceCode r" id="cb100"><code class="sourceCode r"><div class="sourceLine" id="cb100-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(S, <span class="dt">freq=</span><span class="st">"months"</span>,<span class="dt">FUN=</span>mean, <span class="dt">output=</span><span class="st">"Soil"</span>)</div></code></pre>
<pre><code>##                  W.1       W.2     ML.1     ML.2    MLTot  WTD      SWE
## 2001-04-01 0.9735342 0.9931676 66.62691 126.3883 193.0152 1000 1.578978
## 2001-05-01 0.8928562 0.9649959 61.10545 122.8032 183.9087 1000 0.000000
## 2001-06-01 0.6858044 0.8587249 46.93521 109.2794 156.2146 1000 0.000000
##            PlantExt.1 PlantExt.2 HydraulicInput.1 HydraulicInput.2
## 2001-04-01  0.4371797  0.2855046      0.000000000                0
## 2001-05-01  0.5386865  0.4055621      0.002957157                0
## 2001-06-01  0.4223659  0.6939848      0.075629147                0
##                  psi.1       psi.2
## 2001-04-01 -0.03916922 -0.03439474
## 2001-05-01 -0.06506442 -0.03980367
## 2001-06-01 -0.21569861 -0.06794885</code></pre>
<p>Parameter <code>output</code> is used to indicate the element of the <code>spwb</code> object for which we desire summaries. Similarly, it is possible to calculate the average stress of plant cohorts by months:</p>
<pre class="sourceCode r" id="cb102"><code class="sourceCode r"><div class="sourceLine" id="cb102-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(S, <span class="dt">freq=</span><span class="st">"months"</span>,<span class="dt">FUN=</span>mean, <span class="dt">output=</span><span class="st">"PlantStress"</span>)</div></code></pre>
<pre><code>##                 T1_54      T2_68        S1_65
## 2001-04-01 0.04917348 0.02526437 0.0008394931
## 2001-05-01 0.07221723 0.03935568 0.0021221790
## 2001-06-01 0.13262933 0.07924091 0.0036975195</code></pre>
<p>The <code>summary</code> function can be also used to aggregate the output by species. In this case, the values of plant cohorts belonging to the same species will be averaged using LAI values as weights. For example, we may average the daily drought stress across cohorts of the same species (here there is only one cohort by species, so this does not modify the output):</p>
<pre class="sourceCode r" id="cb104"><code class="sourceCode r"><div class="sourceLine" id="cb104-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(S, <span class="dt">freq=</span><span class="st">"day"</span>, <span class="dt">output=</span><span class="st">"PlantStress"</span>, <span class="dt">bySpecies =</span> <span class="ot">TRUE</span>))</div></code></pre>
<pre><code>##            Pinus halepensis Quercus coccifera Quercus ilex
## 2001-04-20       0.03170205      0.0002410749   0.01318335
## 2001-04-21       0.03015776      0.0004457775   0.01309502
## 2001-04-22       0.03915699      0.0002999449   0.01890498
## 2001-04-23       0.04439013      0.0004077261   0.02100917
## 2001-04-24       0.05471853      0.0008485824   0.02579133
## 2001-04-25       0.06604960      0.0011486847   0.03323843</code></pre>
<p>Or we can combine the aggregation by species with a temporal aggregation (here monthly averages):</p>
<pre class="sourceCode r" id="cb106"><code class="sourceCode r"><div class="sourceLine" id="cb106-1" data-line-number="1">
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(S, <span class="dt">freq=</span><span class="st">"month"</span>, <span class="dt">FUN =</span> mean, <span class="dt">output=</span><span class="st">"PlantStress"</span>, <span class="dt">bySpecies =</span> <span class="ot">TRUE</span>)</div></code></pre>
<pre><code>##            Pinus halepensis Quercus coccifera Quercus ilex
## 2001-04-01       0.04917348      0.0008394931   0.02526437
## 2001-05-01       0.07221723      0.0021221790   0.03935568
## 2001-06-01       0.13262933      0.0036975195   0.07924091</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#about-this-vignette">About this vignette</a></li>
      <li><a href="#preparing-model-inputs">Preparing model inputs</a></li>
      <li><a href="#static-analysis-of-submodels">Static analysis of submodels</a></li>
      <li><a href="#water-balance-for-a-single-day">Water balance for a single day</a></li>
      <li><a href="#water-balance-for-multiple-days">Water balance for multiple days</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Miquel De Cáceres, Víctor Granda, Antoine Cabon.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
